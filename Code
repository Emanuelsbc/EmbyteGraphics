import React, { useState, useEffect } from 'react';
import {
  ShoppingCart,
  Package,
  Printer,
  Users,
  LogOut,
  Plus,
  Search,
  AlertTriangle,
  CheckSquare,
  DollarSign,
  Settings,
  Calculator,
  Lock,
  TrendingUp,
  XCircle,
  CheckCircle,
  Eye,
  Save,
  Trash2,
  X,
  Edit,
  Activity,
  Download,
  Upload,
  Tag,
  Scissors,
  ArrowRightLeft,
  MessageCircle,
  Share2,
  Calendar,
  Percent,
  Send,
  Wallet,
  PieChart,
  BarChart2,
  CalendarDays,
  ChevronDown,
  ChevronUp,
  Unlock,
  LockKeyhole,
  Info,
  Banknote,
  FileText,
  ListPlus,
  Ruler,
  Box,
  ClipboardList,
  Clock,
  Check,
  CreditCard,
  ArrowLeft,
  KeyRound,
  CalendarClock,
  AlertCircle,
  ShoppingBag,
  FileBarChart,
  WifiOff,
  Wifi
} from 'lucide-react';

// --- CONFIGURA√á√ÉO DA API ---
const API_BASE_URL = 'http://100.95.120.82:8000/api/data';

// --- HELPERS DE INTEGRA√á√ÉO (SERVIDOR APENAS - SEM LOCALSTORAGE) ---

/**
 * Busca dados exclusivamente do servidor com PROTE√á√ÉO ANTI-CRASH.
 */
const fetchData = async (key, fallbackValue) => {
  if (!navigator.onLine) {
    console.warn(`[SISTEMA] Offline. N√£o √© poss√≠vel buscar ${key}.`);
    return fallbackValue;
  }

  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000); // Timeout aumentado

    const response = await fetch(`${API_BASE_URL}/data/${key}`, {
      signal: controller.signal,
      method: 'GET',
      headers: { 'Accept': 'application/json' }
    });
    clearTimeout(timeoutId);

    if (response.ok) {
      const json = await response.json();

      // L√≥gica de "Desembrulhar" (Unwrap) para garantir que pegamos os dados certos
      let result = json;
      if (json.data !== undefined) result = json.data;

      // PROTE√á√ÉO CR√çTICA: Se esper√°vamos um Array e veio null/objeto, retorna fallback
      if (Array.isArray(fallbackValue) && !Array.isArray(result)) {
        // Tenta achar um array dentro do objeto caso a estrutura esteja aninhada
        if (result && typeof result === 'object') {
          const possibleArray = Object.values(result).find(v => Array.isArray(v));
          if (possibleArray) return possibleArray;
        }
        return fallbackValue;
      }

      // Se result for null/undefined, retorna fallback
      return result !== undefined && result !== null ? result : fallbackValue;
    } else {
      console.error(`[SISTEMA] Erro servidor (${response.status}) ao buscar ${key}`);
    }
  } catch (error) {
    console.warn(`[SISTEMA] Falha na conex√£o para ${key}.`, error);
  }

  return fallbackValue;
};

/**
 * Salva dados exclusivamente no servidor.
 */
const syncData = async (key, data) => {
  if (!navigator.onLine) {
    console.warn(`[SISTEMA] Offline. ${key} N√ÉO FOI SALVO.`);
    return;
  }

  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);

    await fetch(`${API_BASE_URL}/data`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ key, data }),
                signal: controller.signal
    });
    clearTimeout(timeoutId);
    console.log(`[SISTEMA] ${key} salvo no servidor.`);
  } catch (error) {
    console.error(`[SISTEMA] ERRO CR√çTICO: Falha ao salvar ${key} no servidor.`, error);
  }
};

// --- DADOS INICIAIS (LIMPOS) ---

const ROLES = {
  ADMIN: 'admin',
  VENDEDOR: 'vendedor',
  DESIGNER: 'designer'
};

const CREDENTIALS = {
  [ROLES.ADMIN]: 'admin123',
  [ROLES.VENDEDOR]: 'venda123',
  [ROLES.DESIGNER]: 'design123'
};

const INITIAL_INVENTORY = [];
const INITIAL_SERVICES = [];
const INITIAL_CLIENTS = [];
const INITIAL_ORDERS = [];
const INITIAL_BILLS = [];
const INITIAL_LOGS = [{ id: 1, action: 'Sistema Iniciado', user: 'System', time: 'Agora' }];
const INITIAL_TRANSACTIONS = [];
const INITIAL_CLOSINGS = [];
const INITIAL_CASH_STATUS = { isOpen: false, openingBalance: 0 };

const INITIAL_SETTINGS = {
  name: 'Gr√°fica Embyte',
  companyName: '62.975.245 EMANUEL SILVA BEZERRA CANTANHEDE',
  cnpj: '62.975.245/0001-91',
  address: 'Esquina da Avenida Antonio Rabelo, S/N , Ao lado da lanchonete ponto G',
  phone: '(98) 984082399',
  pixKey: '(98) 984082399',
  notify: true,
  printLabel: false,
  blockUnpaid: true
};

// [MODIFICA√á√ÉO] Adicionado 'Terceirizado'
const CATEGORIES = ['Papel', 'M√≠dia', 'Tinta', 'Acabamento', 'Eletr√¥nicos/Produtos', 'Terceirizado', 'Outros'];
const EXPENSE_CATEGORIES = ['Sal√°rios', 'Fornecedores', 'Aluguel/Energia/Net', 'Manuten√ß√£o', 'Impostos', 'Outros'];
const PAYMENT_METHODS = ['Dinheiro (Gaveta)', 'Pix', 'Cart√£o D√©bito', 'Cart√£o Cr√©dito', 'Transfer√™ncia'];

// [MODIFICADO] Workflow Completo: Design -> Produ√ß√£o -> Acabamento -> Final
// [MODIFICADO] Workflow profissional de gr√°fica (8 Etapas)
const PRODUCTION_STEPS_TEMPLATE = [
  // FASE 1: PRODU√á√ÉO
  { id: 'prepress', label: '1. Pr√©-Impress√£o (Arq/Sangria)', done: false, type: 'prod' },
  { id: 'rip', label: '2. RIP / Prepara√ß√£o de M√°quina', done: false, type: 'prod' },
{ id: 'print', label: '3. Impress√£o Rodando', done: false, type: 'prod' },
{ id: 'dry', label: '4. Secagem / Cura da Tinta', done: false, type: 'prod' },
// FASE 2: ACABAMENTO
{ id: 'cut', label: '5. Corte / Refile Final', done: false, type: 'acab' },
{ id: 'finish', label: '6. Acabamentos (Lamina√ß√£o/Dobra)', done: false, type: 'acab' },
{ id: 'qc', label: '7. Controle de Qualidade', done: false, type: 'acab' },
{ id: 'pack', label: '8. Embalagem e Etiquetagem', done: false, type: 'acab' }
];

// --- HELPERS DE FORMATA√á√ÉO ---

const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val || 0);
const formatDate = (dateString) => {
  if (!dateString) return '-';
  // Corrige problema de timezone considerando a string como data local
  const parts = dateString.split('-');
  if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
  return new Date(dateString).toLocaleDateString('pt-BR');
};
const formatDateTime = (dateString) => new Date(dateString).toLocaleString('pt-BR');

// --- COMPONENTES UI ---

const Button = ({ children, onClick, variant = 'primary', className = '', type = 'button', disabled = false, title = '' }) => {
  const baseStyle = "px-4 py-2 text-sm font-medium transition-colors duration-150 uppercase tracking-wider border rounded-none focus:outline-none focus:ring-1 focus:ring-zinc-500 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center";
  const variants = {
    primary: "bg-blue-700 hover:bg-blue-600 text-white border-blue-800",
    secondary: "bg-zinc-800 hover:bg-zinc-700 text-zinc-300 border-zinc-700",
    danger: "bg-red-900/50 hover:bg-red-900 text-red-200 border-red-800",
    success: "bg-emerald-900/50 hover:bg-emerald-900 text-emerald-200 border-emerald-800",
    whatsapp: "bg-emerald-600 hover:bg-emerald-500 text-white border-emerald-700",
    outline: "bg-transparent hover:bg-zinc-800 text-zinc-400 border-zinc-600",
    ghost: "bg-transparent text-zinc-500 hover:text-white border-transparent"
  };
  return <button type={type} onClick={onClick} disabled={disabled} title={title} className={`${baseStyle} ${variants[variant]} ${className}`}>{children}</button>;
};

const Badge = ({ status }) => {
  const styles = {
    orcamento: "bg-zinc-800 text-zinc-400 border-zinc-600",
    aguardando_pagamento: "bg-yellow-900/30 text-yellow-500 border-yellow-900",
    producao: "bg-blue-900/30 text-blue-400 border-blue-900",
    acabamento: "bg-purple-900/30 text-purple-400 border-purple-900",
    concluido: "bg-emerald-900/30 text-emerald-500 border-emerald-900",
    cancelado: "bg-red-900/30 text-red-500 border-red-900",
    pendente: "bg-red-900/30 text-red-400 border-red-900",
    pago: "bg-emerald-900/30 text-emerald-400 border-emerald-900",
  };
  const labels = {
    orcamento: "Or√ßamento",
    aguardando_pagamento: "Aguard. Sinal",
    producao: "Em Produ√ß√£o",
    acabamento: "Acabamento",
    concluido: "Entregue",
    cancelado: "Cancelado",
    pendente: "A Pagar",
    pago: "Pago"
  };
  return <span className={`px-2 py-1 text-xs font-mono uppercase border ${styles[status] || styles.orcamento} rounded-none whitespace-nowrap`}>{labels[status] || status}</span>;
};

const Input = ({ label, type = "text", placeholder, value, onChange, name, readOnly = false, required = false, autoFocus = false, onKeyDown }) => (
  <div className="flex flex-col gap-1 mb-4 w-full">
  <label className="text-xs uppercase text-zinc-500 font-bold tracking-wider">{label} {required && <span className="text-red-500">*</span>}</label>
  <input
  type={type} name={name} value={value} onChange={onChange} placeholder={placeholder} readOnly={readOnly} required={required} autoFocus={autoFocus} onKeyDown={onKeyDown}
  className={`bg-zinc-950 border border-zinc-700 text-zinc-200 p-2 rounded-none focus:border-blue-700 focus:outline-none placeholder-zinc-700 font-mono text-sm w-full ${readOnly ? 'opacity-50 cursor-not-allowed' : ''}`}
  />
  </div>
);

const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm animate-in fade-in duration-200">
    <div className="bg-zinc-900 border border-zinc-700 shadow-2xl w-full max-w-lg mx-4 flex flex-col max-h-[90vh]">
    <div className="flex justify-between items-center p-4 border-b border-zinc-800 bg-zinc-950">
    <h3 className="text-lg font-bold text-white uppercase tracking-wider">{title}</h3>
    <button onClick={onClose} className="text-zinc-500 hover:text-white transition-colors"><X size={20} /></button>
    </div>
    <div className="p-6 overflow-y-auto">{children}</div>
    </div>
    </div>
  );
};

const Toast = ({ message, type, onClose }) => {
  useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
  return (
    <div className={`fixed top-4 right-4 z-[60] flex items-center gap-3 px-6 py-4 border-l-4 shadow-2xl animate-in slide-in-from-right-10 fade-in duration-300 bg-zinc-900 ${type === 'error' ? 'border-red-600 text-red-200' : 'border-emerald-600 text-emerald-200'}`}>
    {type === 'error' ? <XCircle size={20} /> : <CheckCircle size={20} />}
    <span className="font-medium uppercase tracking-wide text-sm">{message}</span>
    </div>
  );
};

const LoginScreen = ({ onLogin }) => {
  const [selectedRole, setSelectedRole] = useState(null);
  const [password, setPassword] = useState('');
  const [error, setError] = useState(false);

  const handleLoginAttempt = (e) => {
    e.preventDefault();
    if (CREDENTIALS[selectedRole] === password) {
      onLogin(selectedRole);
    } else {
      setError(true);
      setPassword('');
      setTimeout(() => setError(false), 2000);
    }
  };

  return (
    <div className="min-h-screen bg-zinc-950 flex items-center justify-center p-4 relative overflow-hidden">
    <div className="absolute inset-0 opacity-10" style={{ backgroundImage: 'radial-gradient(#3b82f6 1px, transparent 1px)', backgroundSize: '30px 30px' }}></div>

    <div className="w-full max-w-md bg-zinc-900 border border-zinc-800 p-10 shadow-2xl relative z-10 transition-all duration-300">
    <div className="mb-8 text-center border-b border-zinc-800 pb-6">
    <h1 className="text-4xl font-black text-white tracking-tighter uppercase mb-2">Embyte<span className="text-blue-600">.SYS</span></h1>
    <div className="inline-flex items-center gap-2 px-3 py-1 bg-zinc-950 border border-zinc-800 rounded-none">
    <Lock className="w-3 h-3 text-zinc-500" />
    <span className="text-zinc-500 text-xs font-mono uppercase">Acesso Seguro (Server Only)</span>
    </div>
    </div>

    {!selectedRole ? (
      <div className="space-y-3 animate-in fade-in slide-in-from-left-4 duration-300">
      <p className="text-zinc-500 text-xs uppercase font-bold mb-4 text-center">Selecione seu perfil de acesso</p>
      <Button onClick={() => setSelectedRole(ROLES.ADMIN)} className="w-full justify-between py-4 group hover:border-blue-500" variant="outline">
      <span className="flex items-center gap-2"><KeyRound size={16}/> Administrador</span>
      <ArrowLeft size={16} className="rotate-180 opacity-0 group-hover:opacity-100 transition-opacity"/>
      </Button>
      <Button onClick={() => setSelectedRole(ROLES.VENDEDOR)} className="w-full justify-between py-4 group hover:border-emerald-500" variant="outline">
      <span className="flex items-center gap-2"><ShoppingCart size={16}/> Vendedor</span>
      <ArrowLeft size={16} className="rotate-180 opacity-0 group-hover:opacity-100 transition-opacity"/>
      </Button>
      <Button onClick={() => setSelectedRole(ROLES.DESIGNER)} className="w-full justify-between py-4 group hover:border-purple-500" variant="outline">
      <span className="flex items-center gap-2"><Scissors size={16}/> Designer</span>
      <ArrowLeft size={16} className="rotate-180 opacity-0 group-hover:opacity-100 transition-opacity"/>
      </Button>
      </div>
    ) : (
      <form onSubmit={handleLoginAttempt} className="animate-in fade-in slide-in-from-right-4 duration-300">
      <div className="flex items-center gap-2 mb-6 text-zinc-400 cursor-pointer hover:text-white transition-colors" onClick={() => { setSelectedRole(null); setPassword(''); setError(false); }}>
      <ArrowLeft size={16}/> <span className="text-xs uppercase font-bold">Voltar</span>
      </div>

      <div className="mb-6 text-center">
      <div className="w-16 h-16 bg-zinc-800 rounded-full flex items-center justify-center mx-auto mb-3 border border-zinc-700">
      {selectedRole === ROLES.ADMIN && <KeyRound size={24} className="text-blue-500"/>}
      {selectedRole === ROLES.VENDEDOR && <ShoppingCart size={24} className="text-emerald-500"/>}
      {selectedRole === ROLES.DESIGNER && <Scissors size={24} className="text-purple-500"/>}
      </div>
      <h2 className="text-white font-bold uppercase tracking-wider">{selectedRole}</h2>
      <p className="text-zinc-500 text-xs">Digite sua senha para continuar</p>
      </div>

      <div className="relative mb-6">
      <Input
      label="Senha de Acesso"
      type="password"
      value={password}
      onChange={(e) => { setPassword(e.target.value); setError(false); }}
      autoFocus
      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
      />
      {error && (
        <div className="absolute -bottom-5 left-0 text-xs text-red-500 font-bold flex items-center gap-1 animate-in slide-in-from-top-1">
        <AlertTriangle size={12}/> Senha incorreta
        </div>
      )}
      </div>

      <Button type="submit" className="w-full py-3" variant="primary" disabled={!password}>
      Entrar no Sistema
      </Button>

      <div className="mt-4 text-center">
      <p className="text-[10px] text-zinc-600">Esqueceu a senha? Contate o suporte t√©cnico.</p>
      </div>
      </form>
    )}
    </div>
    </div>
  );
};

// --- APLICA√á√ÉO PRINCIPAL ---

export default function GraficaEmbyte() {

  // [MODIFICA√á√ÉO] Inicializa buscando do localStorage se existir
  const [user, setUser] = useState(() => {
    const saved = localStorage.getItem('embyte_user');
    return saved ? JSON.parse(saved) : null;
  });

  // [MODIFICA√á√ÉO] Define a tela inicial baseada no usu√°rio salvo
  const [view, setView] = useState(() => {
    const saved = localStorage.getItem('embyte_user');
    if (saved) {
      const u = JSON.parse(saved);
      return u.role === 'designer' ? 'producao' : 'financeiro'; // Ajuste 'designer' conforme sua constante ROLES se necess√°rio
    }
    return 'login';
  });

  // Controle de Carregamento da API e Modo de Seguran√ßa
  const [isDataLoaded, setIsDataLoaded] = useState(false);
  const [isOffline, setIsOffline] = useState(!navigator.onLine);

  // Estados com valores iniciais padr√£o
  const [orders, setOrders] = useState(INITIAL_ORDERS);
  const [inventory, setInventory] = useState(INITIAL_INVENTORY);
  const [services, setServices] = useState(INITIAL_SERVICES);
  const [clients, setClients] = useState(INITIAL_CLIENTS);
  const [logs, setLogs] = useState(INITIAL_LOGS);
  const [transactions, setTransactions] = useState(INITIAL_TRANSACTIONS);
  const [bills, setBills] = useState(INITIAL_BILLS);
  const [cashClosings, setCashClosings] = useState(INITIAL_CLOSINGS);
  const [cashStatus, setCashStatus] = useState(INITIAL_CASH_STATUS);
  const [settings, setSettings] = useState(INITIAL_SETTINGS);

  const [cart, setCart] = useState([]);

  // Estados para Relat√≥rios
  const [reportType, setReportType] = useState('vendas');
  const [reportStartDate, setReportStartDate] = useState(new Date().toISOString().split('T')[0]);
  const [reportEndDate, setReportEndDate] = useState(new Date().toISOString().split('T')[0]);

  // Estados UI
  const [notification, setNotification] = useState(null);
  const [modalOpen, setModalOpen] = useState(false);
  const [modalType, setModalType] = useState(null);
  const [editingItem, setEditingItem] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [inventoryFilter, setInventoryFilter] = useState('all');
  const [expandedDay, setExpandedDay] = useState(null);
  const [saleTab, setSaleTab] = useState('service');

  // Estados de Formul√°rio
  const [tempClient, setTempClient] = useState({ name: '', doc: '', contact: '', email: '' });
  const [tempInventory, setTempInventory] = useState({ name: '', category: 'Outros', unit: '', measureType: 'unit', quantity: 0, minStock: 0, price: 0, sellPrice: 0 });
  const [tempMovement, setTempMovement] = useState({ type: 'in', quantity: 0, reason: 'Compra' });
  const [tempService, setTempService] = useState({ name: '', w: '', h: '', basePrice: '', extras: [], stockId: '', pricingType: 'sheet' });
  const [tempExtra, setTempExtra] = useState({ name: '', value: '' });
  const [tempTransaction, setTempTransaction] = useState({ type: 'in', description: '', value: 0, category: 'Vendas', method: 'Dinheiro (Gaveta)' });
  const [tempBill, setTempBill] = useState({ description: '', value: '', dueDate: '', category: 'Fornecedores', obs: '' });
  const [paymentData, setPaymentData] = useState({ orderId: null, totalValue: 0, minValue: 0, payValue: 0, type: 'signal', method: 'Pix' });
  const [openingValue, setOpeningValue] = useState('');
  const [tempDeliveryDate, setTempDeliveryDate] = useState('');
  // Vari√°veis de controle da Produ√ß√£o
  const [prodFilter, setProdFilter] = useState('all');
  const [expandedOP, setExpandedOP] = useState(null);
  const [productionNote, setProductionNote] = useState('');

  // Estados de Calculadora
  const [calcData, setCalcData] = useState({
    itemW: '', itemH: '', quantity: '', serviceId: '', sides: 1, finishCost: 0, discount: 0, deliveryTime: '5 dias √∫teis', selectedExtras: []
  });
  const [productSaleData, setProductSaleData] = useState({
    inventoryId: '', quantity: '', unitPrice: ''
  });

  const [calcResult, setCalcResult] = useState(null);
  const [editingOrderId, setEditingOrderId] = useState(null);
  const [selectedClientId, setSelectedClientId] = useState('');
  // ... outros estados ...

  useEffect(() => {
    const handleOnline = () => setIsOffline(false);
    const handleOffline = () => setIsOffline(true);
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  // 1. CARREGAR DADOS COM PROTE√á√ÉO
  useEffect(() => {
    const loadAllData = async () => {
      try {
        const [
          loadedOrders,
          loadedInventory,
          loadedServices,
          loadedClients,
          loadedLogs,
          loadedTransactions,
          loadedBills,
          loadedClosings,
          loadedCashStatus,
          loadedSettings
        ] = await Promise.all([
          fetchData('embyte_orders', INITIAL_ORDERS),
                              fetchData('embyte_inventory', INITIAL_INVENTORY),
                              fetchData('embyte_services', INITIAL_SERVICES),
                              fetchData('embyte_clients', INITIAL_CLIENTS),
                              fetchData('embyte_logs', INITIAL_LOGS),
                              fetchData('embyte_transactions', INITIAL_TRANSACTIONS),
                              fetchData('embyte_bills', INITIAL_BILLS),
                              fetchData('embyte_closings', INITIAL_CLOSINGS),
                              fetchData('embyte_cash_status', INITIAL_CASH_STATUS),
                              fetchData('embyte_settings', INITIAL_SETTINGS)
        ]);

        // PROTE√á√ÉO: Garante que sejam arrays para evitar .map() crash
        setOrders(Array.isArray(loadedOrders) ? loadedOrders : []);
        setInventory(Array.isArray(loadedInventory) ? loadedInventory : []);
        setServices(Array.isArray(loadedServices) ? loadedServices : []);
        setClients(Array.isArray(loadedClients) ? loadedClients : []);
        setLogs(Array.isArray(loadedLogs) ? loadedLogs : []);
        setTransactions(Array.isArray(loadedTransactions) ? loadedTransactions : []);
        setBills(Array.isArray(loadedBills) ? loadedBills : []);
        setCashClosings(Array.isArray(loadedClosings) ? loadedClosings : []);

        setCashStatus(loadedCashStatus || INITIAL_CASH_STATUS);
        setSettings(prev => ({ ...prev, ...loadedSettings }));

        setIsDataLoaded(true);
        console.log("Sistema: Dados carregados e validados.");
      } catch (e) {
        console.warn("Erro ao carregar dados. Usando padr√£o.", e);
        setIsDataLoaded(true);
      }
    };

    loadAllData();
  }, []);

  // 2. SINCRONIZAR
  useEffect(() => { if(isDataLoaded) syncData('embyte_orders', orders); }, [orders, isDataLoaded]);
  useEffect(() => { if(isDataLoaded) syncData('embyte_inventory', inventory); }, [inventory, isDataLoaded]);
  useEffect(() => { if(isDataLoaded) syncData('embyte_services', services); }, [services, isDataLoaded]);
  useEffect(() => { if(isDataLoaded) syncData('embyte_clients', clients); }, [clients, isDataLoaded]);
  useEffect(() => { if(isDataLoaded) syncData('embyte_logs', logs); }, [logs, isDataLoaded]);
  useEffect(() => { if(isDataLoaded) syncData('embyte_settings', settings); }, [settings, isDataLoaded]);
  useEffect(() => { if(isDataLoaded) syncData('embyte_transactions', transactions); }, [transactions, isDataLoaded]);
  useEffect(() => { if(isDataLoaded) syncData('embyte_bills', bills); }, [bills, isDataLoaded]);
  useEffect(() => { if(isDataLoaded) syncData('embyte_closings', cashClosings); }, [cashClosings, isDataLoaded]);
  useEffect(() => { if(isDataLoaded) syncData('embyte_cash_status', cashStatus); }, [cashStatus, isDataLoaded]);

  // --- L√ìGICA DE NEG√ìCIO ---

  const addLog = (action) => {
    const newLog = { id: Date.now(), action, user: user ? user.name : 'Sistema', time: new Date().toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' }) };
    setLogs(prev => [newLog, ...prev.slice(0, 99)]);
  };

  const showToast = (msg, type = 'success') => {
    setNotification({ message: msg, type });
  };

  const getClientPhone = (clientName) => {
    const client = clients.find(c => c.name.toLowerCase().trim() === clientName.toLowerCase().trim());
    return client ? client.contact.replace(/\D/g, '') : '';
  };

  const sendWhatsApp = (data, type = 'orcamento') => {
    let phone = '';
    let clientName = '';
    let text = '';

    if (data.contact) {
      phone = data.contact.replace(/\D/g, '');
      clientName = data.name;
    } else {
      phone = getClientPhone(data.client);
      clientName = data.client;
    }

    if (!phone) { showToast("Cliente sem telefone cadastrado!", "error"); return; }

    const saudacao = `Ol√° *${clientName.split(' ')[0]}*, tudo bem?`;

    switch (type) {
      case 'orcamento':
        const deliveryText = data.deliveryTime ? `\nüïí *Prazo:* ${data.deliveryTime}` : '';
        text = `${saudacao}\n\n` +
        `Aqui est√° o resumo do or√ßamento *#${data.id}* na *${settings.name.toUpperCase()}*:\n\n` +
        `üìÑ *Descri√ß√£o Geral:* ${data.description}\n` +
        `üí≤ *Valor Total:* ${formatCurrency(data.value)}` +
        `${data.discount > 0 ? ` (j√° com desconto)` : ''}` +
        `${deliveryText}\n\n` +
        `Ficamos no aguardo da sua aprova√ß√£o! üëã`;
        break;
      case 'sinal':
        text = `${saudacao}\n\n` +
        `Recebemos a aprova√ß√£o do pedido *#${data.id}*. ‚úÖ\n\n` +
        `Para iniciarmos a produ√ß√£o, precisamos da confirma√ß√£o do sinal.\n` +
        `Valor Total: ${formatCurrency(data.value)}\n` +
        `*Sinal (50%): ${formatCurrency(data.value / 2)}*\n\n` +
        `üîë *Chave PIX:* ${settings.pixKey || settings.cnpj}\n\n` +
        `Assim que enviar o comprovante, j√° colocamos na m√°quina! üöÄ`;
        break;
      case 'andamento':
        text = `${saudacao}\n\n` +
        `Passando para avisar que seu pedido *#${data.id}* j√° est√° na fase de *${data.status === 'producao' ? 'Impress√£o/Produ√ß√£o' : 'Acabamento/Corte'}*. üñ®Ô∏è‚úÇÔ∏è\n\n` +
        `Logo mais avisamos quando estiver pronto!`;
        break;
      case 'pronto':
        text = `${saudacao} üëã\n\n` +
        `‚ú® Boa not√≠cia! Seu pedido *#${data.id}* (${data.description}) est√° *PRONTO* e dispon√≠vel para retirada. üì¶\n\n` +
        `üìç Endere√ßo: ${settings.address}\n\n` +
        `Aguardamos voc√™!`;
        break;
      case 'geral':
        text = `${saudacao}\n\n` +
        `Estou entrando em contato referente √† gr√°fica ${settings.name}. Como posso ajudar hoje?`;
        break;
      default:
        text = `${saudacao}`;
    }
    window.open(`https://wa.me/55${phone}?text=${encodeURIComponent(text)}`, '_blank');
    addLog(`WhatsApp enviado p/ ${clientName} (${type})`);
  };

  const openModal = (type, item = null) => {
    setModalType(type);
    setEditingItem(item);
    if (type === 'client') setTempClient(item || { name: '', doc: '', contact: '', email: '' });
    else if (type === 'inventory') setTempInventory(item || { name: '', category: 'Outros', unit: '', measureType: 'unit', quantity: 0, minStock: 0, price: 0, sellPrice: 0 });
    else if (type === 'service') setTempService(item || { name: '', w: '', h: '', basePrice: '', extras: [], stockId: '', pricingType: 'sheet' });
    else if (type === 'movement') setTempMovement({ type: 'in', quantity: 0, reason: 'Compra' });
    else if (type === 'transaction') setTempTransaction({ type: 'in', description: '', value: 0, category: 'Vendas', method: 'Dinheiro (Gaveta)' });
    else if (type === 'bill') setTempBill(item || { description: '', value: '', dueDate: '', category: 'Fornecedores', obs: '' });
    else if (type === 'productionManage') setProductionNote('');
    setModalOpen(true);
  };

  const payBill = (bill) => {
    if (!cashStatus.isOpen) {
      if(!window.confirm("O Caixa est√° FECHADO. Deseja registrar o pagamento mesmo assim? (N√£o afetar√° saldo da gaveta de hoje se for transfer√™ncia)")) return;
    }

    const val = parseFloat(bill.value);

    const newTrans = {
      id: Date.now(),
      type: 'out',
      description: `Pagamento Conta: ${bill.description}`,
      value: val,
      date: new Date().toISOString().split('T')[0],
      category: bill.category,
      method: 'Outros'
    };
    setTransactions([newTrans, ...transactions]);

    const updatedBills = bills.map(b => b.id === bill.id ? { ...b, status: 'pago', paidDate: new Date().toISOString() } : b);
    setBills(updatedBills);

    addLog(`Conta Paga: ${bill.description} (${formatCurrency(val)})`);
    showToast("Conta paga e registrada nas sa√≠das!");
  };

  const saveData = (e) => {
    e.preventDefault();
    const id = editingItem ? editingItem.id : Date.now();
    if (modalType === 'client') {
      const newList = editingItem ? clients.map(c => c.id === id ? { ...tempClient, id, totalSpent: c.totalSpent } : c) : [...clients, { ...tempClient, id, totalSpent: 0 }];
      setClients(newList);
      addLog(`Cliente ${editingItem ? 'editado' : 'criado'}: ${tempClient.name}`);
    } else if (modalType === 'inventory') {
      // [MODIFICA√á√ÉO] Se for terceirizado, define estoque infinito (99999) para n√£o alertar falta
      const isTerceirizado = tempInventory.category === 'Terceirizado';
      const itemToSave = {
        ...tempInventory,
        quantity: isTerceirizado ? 99999 : +tempInventory.quantity,
        minStock: isTerceirizado ? 0 : +tempInventory.minStock,
        price: +tempInventory.price,
        // ... continua igual ...       price: +tempInventory.price,
        sellPrice: +tempInventory.sellPrice || 0
      };
      const newList = editingItem ? inventory.map(i => i.id === id ? { ...itemToSave, id } : i) : [...inventory, { ...itemToSave, id }];
      setInventory(newList);
      addLog(`Stock ${editingItem ? 'editado' : 'criado'}: ${tempInventory.name}`);
    } else if (modalType === 'movement') {
      if (!editingItem) return;
      const qty = parseFloat(tempMovement.quantity);
      if (qty <= 0) { showToast("Qtd inv√°lida", "error"); return; }
      const newQty = tempMovement.type === 'in' ? editingItem.quantity + qty : editingItem.quantity - qty;
      if (newQty < 0) { showToast("Saldo insuficiente", "error"); return; }
      setInventory(inventory.map(i => i.id === editingItem.id ? { ...i, quantity: newQty } : i));
      addLog(`Movimenta√ß√£o: ${tempMovement.type === 'in' ? '+' : '-'}${qty} em ${editingItem.name}`);
      showToast("Movimenta√ß√£o registrada!");
    } else if (modalType === 'service') {
      const itemToSave = { ...tempService, w: +tempService.w, h: +tempService.h, basePrice: +tempService.basePrice, stockId: +tempService.stockId };
      const newList = editingItem ? services.map(p => p.id === id ? { ...itemToSave, id } : p) : [...services, { ...itemToSave, id }];
      setServices(newList);
      addLog(`Servi√ßo ${editingItem ? 'editado' : 'criado'}: ${tempService.name}`);
    } else if (modalType === 'transaction') {
      if (!cashStatus.isOpen) { showToast("O Caixa est√° fechado!", "error"); return; }
      const val = parseFloat(tempTransaction.value);
      if (val <= 0) { showToast("Valor inv√°lido", "error"); return; }
      const newTrans = {
        id: Date.now(),
        type: tempTransaction.type,
        description: tempTransaction.description,
        value: val,
        date: new Date().toISOString().split('T')[0],
        category: tempTransaction.category,
        method: tempTransaction.method
      };
      setTransactions([newTrans, ...transactions]);
      addLog(`Lan√ßamento manual Caixa: ${tempTransaction.type} ${val} (${tempTransaction.method})`);
      showToast("Lan√ßamento registrado!");
    } else if (modalType === 'bill') {
      const val = parseFloat(tempBill.value);
      if (val <= 0 || !tempBill.description || !tempBill.dueDate) { showToast("Dados inv√°lidos", "error"); return; }

      const billData = {
        id: id,
        description: tempBill.description,
        value: val,
        dueDate: tempBill.dueDate,
        category: tempBill.category,
        obs: tempBill.obs,
        status: editingItem ? editingItem.status : 'pendente',
        paidDate: editingItem ? editingItem.paidDate : null
      };

      const newList = editingItem ? bills.map(b => b.id === id ? billData : b) : [...bills, billData];
      setBills(newList);
      addLog(`Conta ${editingItem ? 'editada' : 'agendada'}: ${tempBill.description}`);
      showToast("Conta salva com sucesso!");
    }
    if (modalType !== 'movement' && modalType !== 'transaction' && modalType !== 'productionManage') showToast("Salvo com sucesso!");
    if (modalType !== 'productionManage') setModalOpen(false);
  };

    const deleteData = (type, id) => {
      if (!window.confirm("Apagar permanentemente?")) return;
      if (type === 'client') setClients(clients.filter(c => c.id !== id));
      if (type === 'inventory') setInventory(inventory.filter(i => i.id !== id));
      if (type === 'service') setServices(services.filter(p => p.id !== id));
      if (type === 'order') setOrders(orders.filter(o => o.id !== id));
      if (type === 'transaction') setTransactions(transactions.filter(t => t.id !== id));
      if (type === 'bill') setBills(bills.filter(b => b.id !== id));
      showToast("Item removido.", "error");
    };

    const addExtraToService = () => {
      if (!tempExtra.name || !tempExtra.value) return;
      const newExtra = { id: Date.now(), name: tempExtra.name, value: parseFloat(tempExtra.value) };
      setTempService({ ...tempService, extras: [...(tempService.extras || []), newExtra] });
      setTempExtra({ name: '', value: '' });
    };

    const removeExtraFromService = (extraId) => {
      setTempService({ ...tempService, extras: tempService.extras.filter(ex => ex.id !== extraId) });
    };

    const toggleExtraSelection = (extraId) => {
      const current = calcData.selectedExtras || [];
      setCalcData({ ...calcData, selectedExtras: current.includes(extraId) ? current.filter(id => id !== extraId) : [...current, extraId] });
    };

    const toggleProductionStep = (orderId, stepId) => {
      setOrders(prevOrders => prevOrders.map(order => {
        if (order.id === orderId) {
          const steps = order.productionSteps || PRODUCTION_STEPS_TEMPLATE.map(s => ({ ...s }));
          const newSteps = steps.map(s => s.id === stepId ? { ...s, done: !s.done } : s);

          const stepLabel = PRODUCTION_STEPS_TEMPLATE.find(s => s.id === stepId)?.label;
          const action = newSteps.find(s => s.id === stepId).done ? 'concluiu' : 'desmarcou';

      const history = [...(order.history || []), {
        date: new Date().toISOString(),
                                             action: `${action} a etapa: ${stepLabel}`,
                                             user: user.name
      }];

      return { ...order, productionSteps: newSteps, history };
        }
        return order;
      }));
    };

    const addProductionNote = (orderId) => {
      if (!productionNote.trim()) return;
      setOrders(prevOrders => prevOrders.map(order => {
        if (order.id === orderId) {
          const history = [...(order.history || []), {
            date: new Date().toISOString(),
                                             action: `Nota: ${productionNote}`,
                                             user: user.name,
                                             type: 'note'
          }];
          return { ...order, history };
        }
        return order;
      }));
      setProductionNote('');
      showToast("Nota adicionada!");
    };

    const calculateBudget = () => {
      const w = parseFloat(calcData.itemW);
      const h = parseFloat(calcData.itemH);
      const qty = parseInt(calcData.quantity);
      const service = services.find(p => p.id === parseInt(calcData.serviceId));

      if (!w || !h || !qty || !service) { showToast("Dados incompletos.", "error"); return; }

      let productionPrice = 0;
      let details = {};

      const linkedStock = inventory.find(i => i.id === service.stockId);
      const materialCost = linkedStock ? linkedStock.price : 0;

      if (service.pricingType === 'area') {
        const areaPerItem = (w * h) / 10000;
        const totalArea = areaPerItem * qty;

        let extrasCostTotal = 0;
        let selectedExtrasNames = [];

        if (service.extras && calcData.selectedExtras) {
          service.extras.forEach(ex => {
            if (calcData.selectedExtras.includes(ex.id)) {
              extrasCostTotal += ex.value;
              selectedExtrasNames.push(ex.name);
            }
          });
        }

        const finalPricePerM2 = service.basePrice + extrasCostTotal;
        productionPrice = totalArea * finalPricePerM2;

        details = {
          fit: 'N/A',
          totalSheets: totalArea.toFixed(2),
          baseSheetsPrice: totalArea * service.basePrice,
          extrasPrice: totalArea * extrasCostTotal,
          totalCost: totalArea * materialCost,
          serviceName: service.name,
          selectedExtrasNames: selectedExtrasNames.join(', '),
          stockId: service.stockId,
          isArea: true
        };
      }
      else {
        const sheetW = service.w - 1;
        const sheetH = service.h - 1;
        const fitA = Math.floor(sheetW / w) * Math.floor(sheetH / h);
        const fitB = Math.floor(sheetW / h) * Math.floor(sheetH / w);
        const bestFit = Math.max(fitA, fitB);

        if (bestFit === 0) { showToast("Item maior que a folha.", "error"); return; }

        const totalSheets = Math.ceil(qty / bestFit);
        const wasteSheets = totalSheets > 10 ? Math.ceil(totalSheets * 0.10) : 0;
        const finalSheets = totalSheets + wasteSheets;

        let extrasCostTotal = 0;
        let selectedExtrasNames = [];

        if (service.extras && calcData.selectedExtras) {
          service.extras.forEach(ex => {
            if (calcData.selectedExtras.includes(ex.id)) {
              extrasCostTotal += ex.value;
              selectedExtrasNames.push(ex.name);
            }
          });
        }

        const pricePerSheet = service.basePrice + extrasCostTotal;
        productionPrice = finalSheets * pricePerSheet;

        details = {
          fit: bestFit,
          totalSheets: finalSheets,
          baseSheetsPrice: finalSheets * service.basePrice,
          extrasPrice: finalSheets * extrasCostTotal,
          totalCost: finalSheets * materialCost,
          serviceName: service.name,
          selectedExtrasNames: selectedExtrasNames.join(', '),
          stockId: service.stockId,
          isArea: false
        };
      }

      const finishCost = parseFloat(calcData.finishCost || 0);
      const sellPrice = productionPrice + finishCost;
      const discount = parseFloat(calcData.discount || 0);
      const finalPrice = sellPrice - discount;

      setCalcResult({
        ...details,
        sellPrice,
        finalPrice,
        discount
      });
    };

    const addToCart = () => {
      if (!calcResult) return;
      const newItem = {
        _id: Date.now(),
        ...calcResult,
        technicalParams: { ...calcData },
        description: `${calcData.quantity} un - ${calcResult.serviceName} (${calcData.itemW}x${calcData.itemH}cm)`,
        isProduct: false
      };
      setCart([...cart, newItem]);
      setCalcResult(null);
      setCalcData({ ...calcData, quantity: '', itemW: '', itemH: '', finishCost: 0, discount: 0, selectedExtras: [] });
      showToast("Item adicionado ao or√ßamento!");
    };

    const addProductToCart = () => {
      const { inventoryId, quantity, unitPrice } = productSaleData;
      if(!inventoryId || !quantity || !unitPrice) { showToast("Preencha todos os campos do produto", "error"); return; }

      const product = inventory.find(i => i.id === parseInt(inventoryId));
      if(!product) return;

      if(parseInt(quantity) > product.quantity) {
        showToast(`Aten√ß√£o: Estoque dispon√≠vel √© de apenas ${product.quantity} un`, "error");
        return;
      }

      const finalPrice = parseFloat(quantity) * parseFloat(unitPrice);
      const totalCost = parseFloat(quantity) * product.price;

      const newItem = {
        _id: Date.now(),
        serviceName: product.name,
        description: `Produto/Revenda: ${product.name}`,
        finalPrice: finalPrice,
        totalCost: totalCost,
        stockId: product.id,
        quantity: parseInt(quantity),
        unitPrice: parseFloat(unitPrice),
        technicalParams: { quantity },
        isProduct: true,
        totalSheets: quantity,
        isArea: false
      };

      setCart([...cart, newItem]);
      setProductSaleData({ inventoryId: '', quantity: '', unitPrice: '' });
      showToast("Produto adicionado ao pedido!");
    };

    const removeFromCart = (itemId) => {
      setCart(cart.filter(item => item._id !== itemId));
    };

    // [MODIFICADO] Apenas abre o modal de confirma√ß√£o ao clicar em "Fechar Or√ßamento"
    const handleCreateOrder = () => {
      if (cart.length === 0) { showToast("Adicione itens ao pedido primeiro.", "error"); return; }

      const client = clients.find(c => c.id == selectedClientId);
      if (!client) { showToast("Selecione um cliente cadastrado.", "error"); return; }

      // Define uma data padr√£o (ex: amanh√£ √†s 18:00) para facilitar o preenchimento
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(18, 0, 0, 0);
      setTempDeliveryDate(tomorrow.toISOString().slice(0, 16));

      setModalType('confirmOrder'); // Abre a janela de data
      setModalOpen(true);
    };

    // [NOVO] Fun√ß√£o que realmente cria o pedido ap√≥s escolher a data e clicar em "Confirmar"
    const confirmCreateOrder = (e) => {
      e.preventDefault();

      const client = clients.find(c => c.id == selectedClientId);
      const totalValue = cart.reduce((acc, item) => acc + item.finalPrice, 0);
      const totalCost = cart.reduce((acc, item) => acc + (item.totalCost || 0), 0);
      const descSummary = cart.length === 1 ? cart[0].description : `${cart.length} itens (Ver detalhes)`;
      const timestamp = new Date().toISOString();

      const orderData = {
        client: client.name,
        description: descSummary,
        value: totalValue,
        discount: 0,
        cost: totalCost,
        deliveryDate: tempDeliveryDate, // Salva a data para c√°lculo da cor
        deliveryTime: new Date(tempDeliveryDate).toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}),
        status: 'orcamento',
        date: timestamp.split('T')[0],
        paid: false,
        paidAmount: 0,
        technicalData: { items: cart },
        productionSteps: PRODUCTION_STEPS_TEMPLATE.map(s => ({...s})),
        history: [{ date: timestamp, action: 'Pedido Criado', user: user.name }]
      };

      if (editingOrderId) {
        setOrders(orders.map(o => o.id === editingOrderId ? { ...o, ...orderData } : o));
        showToast("Or√ßamento atualizado!");
        setEditingOrderId(null);
      } else {
        const newOrder = { id: Math.floor(Math.random() * 10000) + 2000, ...orderData };
        setOrders([newOrder, ...orders]);
        showToast("Or√ßamento criado!");
      }

      setCart([]);
      setSelectedClientId('');
      setModalOpen(false); // Fecha o modal
    };

    const handleEditOrder = (order) => {
      if (order.status !== 'orcamento') return;
      if (order.technicalData && order.technicalData.items) {
        setCart(order.technicalData.items);
        setEditingOrderId(order.id);
        const client = clients.find(c => c.name === order.client);
        // CORRE√á√ÉO: Converte ID para string para bater com o value do <select>
        if(client) setSelectedClientId(client.id.toString());
      } else if (order.technicalData) {
        setCalcData({ ...order.technicalData.technicalParams });
        setCalcResult(order.technicalData);
        setEditingOrderId(order.id);
      }
    };

    const openPaymentModal = (order, type = 'signal') => {
      if (!cashStatus.isOpen) {
        showToast("O Caixa est√° FECHADO. Abra o caixa primeiro.", "error");
        return;
      }
      const remaining = order.value - (order.paidAmount || 0);
      const minValue = type === 'signal' ? order.value / 2 : remaining;

      setPaymentData({
        orderId: order.id,
        totalValue: order.value,
        minValue: minValue,
        payValue: minValue,
        type: type,
        method: 'Pix'
      });
      setModalType('payment');
      setModalOpen(true);
    };

    const confirmPayment = (e) => {
      e.preventDefault();
      if (!cashStatus.isOpen) { showToast("Caixa fechado!", "error"); return; }

      const order = orders.find(o => o.id === paymentData.orderId);
      if (!order) return;

      const val = parseFloat(paymentData.payValue);
      if (val < 0.01) { showToast("Valor inv√°lido", "error"); return; }
      if (paymentData.type === 'signal' && val < paymentData.minValue - 0.1) {
        showToast(`Sinal m√≠nimo de 50% (${formatCurrency(paymentData.minValue)})`, "error");
        return;
      }

      const newPaidAmount = (order.paidAmount || 0) + val;
      const isFullPayment = newPaidAmount >= order.value - 0.1;

      if (order.status === 'aguardando_pagamento' && order.technicalData && order.technicalData.items) {
        let tempInv = [...inventory];
        let hasError = false;

        order.technicalData.items.forEach(item => {
          const stockItem = tempInv.find(i => i.id === item.stockId);
          if (stockItem) {
            const deduct = item.isProduct ? parseInt(item.quantity) : (item.isArea ? parseFloat(item.totalSheets) : parseInt(item.totalSheets));

            if (stockItem.quantity < deduct) {
              showToast(`Estoque insuficiente de ${stockItem.name}.`, "error");
              hasError = true;
            } else {
              stockItem.quantity -= deduct;
            }
          }
        });

        if(hasError) return;
        setInventory(tempInv);
      }

      const transactionDesc = paymentData.type === 'signal' ? `Sinal Pedido #${order.id}` : `Pagamento Restante #${order.id}`;

      const items = order.technicalData?.items || [];
      const hasServiceItems = items.some(item => !item.isProduct);
      const isResaleOrder = items.length > 0 && !hasServiceItems;

      const updatedOrders = orders.map(o => {
        if (o.id === order.id) {
          const history = [...(o.history || []), {
            date: new Date().toISOString(),
                                       action: `Pagamento: ${formatCurrency(val)} (${paymentData.type === 'signal' ? 'Sinal' : 'Final'}) - ${paymentData.method}`,
                                       user: user.name
          }];

          let nextStatus = o.status;
          if (o.status === 'aguardando_pagamento') {
            nextStatus = isResaleOrder ? 'concluido' : 'producao';
          }

          return {
            ...o,
            status: nextStatus,
            paid: isFullPayment,
            paidAmount: newPaidAmount,
            history
          };
        }
        return o;
      });
      setOrders(updatedOrders);

      const newTransaction = {
        id: Date.now(),
        type: 'in',
        description: `${transactionDesc} - ${order.client}`,
        value: val,
        date: new Date().toISOString().split('T')[0],
        category: 'Recebimento Pedido',
        method: paymentData.method
      };
      setTransactions([newTransaction, ...transactions]);

      showToast(`Pagamento de ${formatCurrency(val)} registrado!`);
      addLog(transactionDesc);
      setModalOpen(false);
    };

    const handleOpenCash = (e) => {
      e.preventDefault();
      const val = parseFloat(openingValue);
      if (isNaN(val) || val < 0) { showToast("Valor inv√°lido", "error"); return; }

      const newTrans = {
        id: Date.now(),
        type: 'in',
        description: 'Abertura de Caixa',
        value: val,
        date: new Date().toISOString().split('T')[0],
        category: 'Abertura',
        method: 'Dinheiro (Gaveta)'
      };
      setTransactions([newTrans, ...transactions]);
      setCashStatus({ isOpen: true, openingBalance: val });
      showToast("Caixa ABERTO com sucesso!");
      addLog("Caixa Aberto");
      setModalOpen(false);
      setOpeningValue('');
    };

    const closeCashDay = () => {
      if (!cashStatus.isOpen) return;
      const today = new Date().toISOString().split('T')[0];
      const existing = cashClosings.find(c => c.date === today);
      if (existing) {
        if(!window.confirm("J√° existe um fechamento para hoje. Deseja sobrescrever/atualizar?")) return;
      }

      const todayTransactions = transactions.filter(t => t.date === today);
      const openingVal = todayTransactions.filter(t => t.category === 'Abertura').reduce((acc, t) => acc + t.value, 0);
      const operationalIn = todayTransactions.filter(t => t.type === 'in' && t.category !== 'Abertura').reduce((acc, t) => acc + t.value, 0);
      const totalOut = todayTransactions.filter(t => t.type === 'out').reduce((acc, t) => acc + t.value, 0);
      const balance = openingVal + operationalIn - totalOut;

      const closingData = {
        id: Date.now(),
        date: today,
        openingBalance: openingVal,
        operationalIn: operationalIn,
        totalIn: openingVal + operationalIn,
        totalOut,
        balance,
        closedBy: user.name,
        transactionCount: todayTransactions.length
      };

      const newClosings = [closingData, ...cashClosings.filter(c => c.date !== today)];
      setCashClosings(newClosings);
      setCashStatus({ isOpen: false, openingBalance: 0 });

      showToast("Caixa FECHADO e enviado ao Financeiro!");
      addLog(`Fechamento de Caixa: ${today}`);
    };

    const handlePrintReport = (reportType, startDate, endDate) => {
      const printWindow = window.open('', '', 'width=900,height=1100');

      let title = "";
      let headers = [];
      let rows = [];
      let summaryHtml = "";

      // --- CORRE√á√ÉO: Compara√ß√£o de Strings (YYYY-MM-DD) para evitar erro de fuso hor√°rio ---
      if (reportType === 'vendas') {
        title = `Relat√≥rio Detalhado de Vendas (${formatDate(startDate)} a ${formatDate(endDate)})`;
        headers = ['Data', 'Pedido', 'Cliente', 'Custo Prod.', 'Valor Venda', 'Lucro Bruto', 'Margem (%)'];

        const data = orders.filter(o => {
          if (!o.date) return false;
          // Compara strings diretamente: "2024-01-01" >= "2024-01-01"
          return o.date >= startDate && o.date <= endDate;
        });

        let totalRevenue = 0;
        let totalCost = 0;

        rows = data.map(o => {
          const revenue = o.value;
          const cost = o.cost || 0;
          const profit = revenue - cost;
          const margin = revenue > 0 ? (profit / revenue) * 100 : 0;

          totalRevenue += revenue;
          totalCost += cost;

          return [
            formatDate(o.date),
              `#${o.id} <span style="font-size:9px; color:#666">(${o.status})</span>`,
                        o.client,
                        formatCurrency(cost),
                          formatCurrency(revenue),
                            `<span style="font-weight:bold; color:${profit >= 0 ? '#10b981' : '#ef4444'}">${formatCurrency(profit)}</span>`,
                        `${margin.toFixed(1)}%`
          ];
        });

        const totalProfit = totalRevenue - totalCost;
        const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;

        summaryHtml = `
        <div class="summary-grid">
        <div class="summary-box">
        <div class="label">Faturamento Total</div>
        <div class="value">${formatCurrency(totalRevenue)}</div>
        </div>
        <div class="summary-box">
        <div class="label">Custo Total (Produtos/Mat√©ria)</div>
        <div class="value" style="color:#ef4444">${formatCurrency(totalCost)}</div>
        </div>
        <div class="summary-box">
        <div class="label">Lucro Bruto</div>
        <div class="value" style="color:${totalProfit >= 0 ? '#10b981' : '#ef4444'}">${formatCurrency(totalProfit)}</div>
        </div>
        <div class="summary-box">
        <div class="label">Margem M√©dia</div>
        <div class="value">${avgMargin.toFixed(1)}%</div>
        </div>
        </div>
        `;

        // --- FINANCEIRO REPORT ---
      } else if (reportType === 'financeiro') {
        title = `Relat√≥rio Financeiro & Caixa (${formatDate(startDate)} a ${formatDate(endDate)})`;
        headers = ['Data', 'Descri√ß√£o', 'Categoria', 'Tipo', 'Valor'];

        const data = transactions.filter(t => {
          if (!t.date) return false;
          return t.date >= startDate && t.date <= endDate;
        });

        rows = data.map(t => [
          formatDate(t.date),
            t.description,
            t.category,
            t.type === 'in' ? '<span style="color:#10b981; font-weight:bold">Entrada</span>' : '<span style="color:#ef4444; font-weight:bold">Sa√≠da</span>',
            formatCurrency(t.value)
        ]);

        const totalIn = data.filter(t => t.type === 'in').reduce((acc, t) => acc + t.value, 0);
        const totalOut = data.filter(t => t.type === 'out').reduce((acc, t) => acc + t.value, 0);
        const balance = totalIn - totalOut;

        const categoryTotals = data.reduce((acc, t) => {
          acc[t.category] = (acc[t.category] || 0) + t.value;
          return acc;
        }, {});

        const catsHtml = Object.entries(categoryTotals).map(([cat, val]) => `
        <div style="display:flex; justify-content:space-between; border-bottom:1px dashed #eee; padding:4px 0;">
        <span>${cat}</span>
        <strong>${formatCurrency(val)}</strong>
        </div>
        `).join('');

        summaryHtml = `
        <div class="summary-grid">
        <div class="summary-box">
        <div class="label">Total Entradas</div>
        <div class="value" style="color:#10b981">${formatCurrency(totalIn)}</div>
        </div>
        <div class="summary-box">
        <div class="label">Total Sa√≠das</div>
        <div class="value" style="color:#ef4444">${formatCurrency(totalOut)}</div>
        </div>
        <div class="summary-box">
        <div class="label">Saldo do Per√≠odo</div>
        <div class="value" style="font-size:24px; color:${balance >= 0 ? '#2563eb' : '#ef4444'}">${formatCurrency(balance)}</div>
        </div>
        </div>
        <div style="margin-top:20px; padding:15px; border:1px solid #eee; border-radius:6px;">
        <h3 style="margin:0 0 10px 0; font-size:14px; text-transform:uppercase;">Resumo por Categoria</h3>
        ${catsHtml}
        </div>
        `;

        // --- ESTOQUE REPORT ---
      } else if (reportType === 'estoque') {
        title = `Invent√°rio de Estoque e Valoriza√ß√£o (Atual)`;
        headers = ['Item', 'Categoria', 'Qtd', 'Custo Unit.', 'Pre√ßo Venda', 'Valor Custo Total', 'Lucro Potencial'];

        let totalCostVal = 0;
        let totalSellVal = 0;

        rows = inventory.map(i => {
          const costTotal = i.quantity * i.price;
          const sellTotal = i.quantity * (i.sellPrice || 0);
          const profitPotential = i.sellPrice ? (sellTotal - costTotal) : 0;

          totalCostVal += costTotal;
          if(i.sellPrice) totalSellVal += sellTotal;

          return [
            i.name,
            i.category,
            `<span style="font-weight:bold">${i.quantity} ${i.unit}</span>`,
            formatCurrency(i.price),
              i.sellPrice ? formatCurrency(i.sellPrice) : '-',
                             formatCurrency(costTotal),
                               i.sellPrice ? `<span style="color:#10b981">${formatCurrency(profitPotential)}</span>` : '-'
          ];
        });

        const totalPotentialProfit = totalSellVal - totalCostVal;

        summaryHtml = `
        <div class="summary-grid">
        <div class="summary-box">
        <div class="label">Valor em Estoque (Custo)</div>
        <div class="value">${formatCurrency(totalCostVal)}</div>
        </div>
        <div class="summary-box">
        <div class="label">Valor Potencial de Venda</div>
        <div class="value" style="color:#2563eb">${formatCurrency(totalSellVal)}</div>
        </div>
        <div class="summary-box">
        <div class="label">Lucro Potencial Projetado</div>
        <div class="value" style="color:#10b981">${formatCurrency(totalPotentialProfit)}</div>
        </div>
        </div>
        `;
      }

      const styles = `
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
      body { font-family: 'Inter', sans-serif; padding: 40px; color: #1a1a1a; font-size: 11px; background: #fff; }
      h1 { font-size: 24px; font-weight: 800; text-transform: uppercase; margin-bottom: 5px; color: #111; letter-spacing: -0.5px; }
      .meta { font-size: 12px; color: #666; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 15px; }

      .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }
      .summary-box { padding: 15px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; }
      .summary-box .label { font-size: 10px; text-transform: uppercase; font-weight: bold; color: #6b7280; margin-bottom: 5px; }
      .summary-box .value { font-size: 18px; font-weight: 800; color: #111; }

      table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
      th { text-align: left; background-color: #f3f4f6; padding: 10px; font-size: 10px; text-transform: uppercase; color: #374151; font-weight: 800; border-bottom: 2px solid #d1d5db; }
      td { padding: 10px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
      tr:nth-child(even) { background-color: #f9fafb; }

      @media print {
        body { padding: 0; }
        .summary-box { border: 1px solid #ccc; }
        th { background-color: #eee !important; -webkit-print-color-adjust: exact; }
      }
      `;

      const tableRows = rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('');
      const tableHeaders = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

      const htmlContent = `
      <html>
      <head><title>${title}</title><style>${styles}</style></head>
      <body>
      <h1>${title}</h1>
      <div class="meta">Gerado em: ${new Date().toLocaleString()} ‚Ä¢ Usu√°rio: ${user ? user.name : 'Sistema'}</div>

      ${summaryHtml}

      <table><thead>${tableHeaders}</thead><tbody>${tableRows}</tbody></table>

      <script>window.print();</script>
      </body>
      </html>
      `;
      printWindow.document.write(htmlContent);
      printWindow.document.close();
    };

    const handlePrintOP = (order) => {
      const printWindow = window.open('', '', 'width=900,height=1100');
      const items = order.technicalData?.items || (order.technicalData ? [order.technicalData] : []);
      const styles = `
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
      body { font-family: 'Inter', sans-serif; padding: 40px; color: #1a1a1a; line-height: 1.4; font-size: 11px; }
      .header { display: flex; justify-content: space-between; border-bottom: 3px solid #000; padding-bottom: 20px; margin-bottom: 30px; }
      .company-title { font-size: 28px; font-weight: 900; text-transform: uppercase; letter-spacing: -1px; margin: 0; line-height: 1; }
      .company-meta { font-size: 10px; color: #555; margin-top: 5px; }
      .doc-info { text-align: right; }
      .doc-tag { display: inline-block; background: #000; color: #fff; padding: 4px 8px; font-weight: bold; text-transform: uppercase; font-size: 12px; margin-bottom: 5px; }
      .box { border: 1px solid #e5e7eb; border-radius: 6px; padding: 15px; margin-bottom: 25px; background: #f9fafb; }
      .box-title { font-size: 10px; font-weight: 800; text-transform: uppercase; color: #6b7280; margin-bottom: 10px; letter-spacing: 0.5px; border-bottom: 1px solid #e5e7eb; padding-bottom: 5px; }
      .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
      .info-row { margin-bottom: 4px; display: flex; }
      .info-label { width: 80px; font-weight: 600; color: #4b5563; }
      table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
      th { text-align: left; background-color: #f3f4f6; padding: 10px; font-size: 10px; text-transform: uppercase; color: #374151; font-weight: 800; border-bottom: 2px solid #e5e7eb; }
      td { padding: 10px; border-bottom: 1px solid #f3f4f6; vertical-align: top; }
      .col-right { text-align: right; }
      .col-center { text-align: center; }
      .item-name { font-weight: 700; font-size: 12px; color: #111; }
      .item-desc { font-size: 10px; color: #666; margin-top: 2px; }
      .totals-area { display: flex; justify-content: flex-end; }
      .totals-box { width: 250px; }
      .total-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #e5e7eb; }
      .total-final { border-top: 2px solid #000; border-bottom: none; font-size: 16px; font-weight: 900; margin-top: 10px; padding-top: 10px; }
      .alert-box { margin-top: 30px; padding: 10px; background-color: #fefce8; border: 1px solid #eab308; color: #854d0e; font-weight: bold; text-align: center; border-radius: 4px; font-size: 11px; }
      .terms { margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; font-size: 9px; color: #6b7280; text-align: justify; }
      .signatures { margin-top: 60px; display: flex; justify-content: space-between; gap: 40px; page-break-inside: avoid; }
      .sig-line { flex: 1; border-top: 1px solid #000; padding-top: 10px; text-align: center; font-size: 11px; }
      .sig-role { font-size: 9px; color: #666; text-transform: uppercase; margin-top: 2px; }
      .footer { position: fixed; bottom: 30px; left: 40px; right: 40px; text-align: center; font-size: 9px; color: #9ca3af; }
      @media print { body { -webkit-print-color-adjust: exact; } }
      `;

      const itemsRows = items.map(item => `
      <tr>
      <td>
      <div class="item-name">${item.serviceName}</div>
      <div class="item-desc">
      ${item.isProduct
        ? 'Produto de Revenda'
      : `${item.technicalParams?.itemW}x${item.technicalParams?.itemH}cm ${item.isArea ? `(${item.totalSheets} m¬≤)` : ''} ‚Ä¢ ${item.selectedExtrasNames || 'Sem extras'}`}
      </div>
      </td>
      <td class="col-center">${item.quantity || 1}</td>
      <td class="col-right">${formatCurrency((item.finalPrice + (item.discount || 0)) / (item.quantity || 1))}</td>
      <td class="col-right" style="font-weight: bold;">${formatCurrency(item.finalPrice)}</td>
      </tr>
      `).join('');

      const html = `
      <html>
      <head>
      <title>Or√ßamento #${order.id}</title>
      <style>${styles}</style>
      </head>
      <body>
      <div class="header">
      <div>
      <h1 class="company-title">${settings.name}</h1>
      <div class="company-meta">${settings.companyName}</div>
      <div class="company-meta">${settings.address}</div>
      <div class="company-meta">CNPJ: ${settings.cnpj} ‚Ä¢ ${settings.phone}</div>
      </div>
      <div class="doc-info">
      <div class="doc-tag">Or√ßamento Oficial</div>
      <div style="font-size: 18px; font-weight: bold;">#${order.id}</div>
      <div>${new Date(order.date).toLocaleDateString('pt-BR')}</div>
      </div>
      </div>
      <div class="box">
      <div class="box-title">Informa√ß√µes do Cliente</div>
      <div class="grid-2">
      <div>
      <div class="info-row"><span class="info-label">Cliente:</span> <strong>${order.client}</strong></div>
      <div class="info-row"><span class="info-label">Contato:</span> ${getClientPhone(order.client) || '-'}</div>
      </div>
      <div>
      <div class="info-row"><span class="info-label">Entrega:</span> ${order.deliveryTime || 'A combinar'}</div>
      <div class="info-row"><span class="info-label">Status:</span> ${order.status.toUpperCase()}</div>
      </div>
      </div>
      </div>
      <table>
      <thead>
      <tr>
      <th width="50%">Item / Servi√ßo</th>
      <th width="15%" class="col-center">Qtd.</th>
      <th width="15%" class="col-right">Vl. Unit.</th>
      <th width="20%" class="col-right">Total</th>
      </tr>
      </thead>
      <tbody>
      ${itemsRows}
      </tbody>
      </table>
      <div class="totals-area">
      <div class="totals-box">
      <div class="total-row"><span>Subtotal</span> <span>${formatCurrency(order.value + (order.discount || 0))}</span></div>
      ${order.discount > 0 ? `<div class="total-row" style="color: #ef4444; font-weight: bold;"><span>Desconto</span> <span>- ${formatCurrency(order.discount)}</span></div>` : ''}
      <div class="total-row total-final"><span>Total</span> <span>${formatCurrency(order.value)}</span></div>

      <div style="margin-top: 15px; background: #eff6ff; padding: 10px; border-radius: 4px;">
      <div class="total-row" style="color: #2563eb; font-weight: 600;"><span>Valor Pago</span> <span>${formatCurrency(order.paidAmount || 0)}</span></div>
      <div class="total-row" style="color: #374151; font-weight: 600; border-bottom: none;"><span>Saldo Restante</span> <span>${formatCurrency(order.value - (order.paidAmount || 0))}</span></div>
      </div>
      </div>
      </div>
      <div class="alert-box">
      ‚ö†Ô∏è ATEN√á√ÉO: A produ√ß√£o deste pedido s√≥ ser√° iniciada ap√≥s a confirma√ß√£o do pagamento do sinal de 50%.
      </div>
      <div class="terms">
      <strong>Condi√ß√µes Comerciais:</strong>
      <ol style="margin-top: 5px; padding-left: 15px;">
      <li>A produ√ß√£o inicia-se apenas ap√≥s a confirma√ß√£o do pagamento do sinal (50%).</li>
      <li>O prazo de entrega conta a partir da aprova√ß√£o final da arte e pagamento do sinal.</li>
      <li>As cores podem ter varia√ß√£o de cor dependendo do material, qualidade da arte e impress√£o do PDF.</li>
      </ol>
      </div>
      <div class="signatures">
      <div class="sig-line">
      <strong>${settings.name}</strong><br/>
      <span class="sig-role">Respons√°vel</span>
      </div>
      <div class="sig-line">
      <strong>${order.client}</strong><br/>
      <span class="sig-role">Cliente</span>
      </div>
      </div>
      <div class="footer">
      Documento gerado eletronicamente por Sistema Embyte ‚Ä¢ ${new Date().toLocaleString('pt-BR')}
      </div>
      <script>window.print();</script>
      </body>
      </html>
      `;
      printWindow.document.write(html);
      printWindow.document.close();
    };

    const ClientesView = () => {
      const filteredClients = clients.filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase())).sort((a, b) => b.totalSpent - a.totalSpent);
      return (
        <div className="space-y-6 animate-in fade-in duration-300">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div className="bg-zinc-900 border border-zinc-800 p-6">
        <h3 className="text-lg font-bold text-white uppercase mb-4 flex items-center gap-2"><TrendingUp className="text-blue-500" /> Curva ABC</h3>
        <div className="space-y-4">
        {filteredClients.slice(0, 3).map((client, idx) => (
          <div key={client.id} className="flex items-center justify-between border-b border-zinc-800 pb-2 last:border-0">
          <div className="flex items-center gap-3">
          <div className={`w-8 h-8 flex items-center justify-center font-bold text-sm rounded-none ${idx === 0 ? 'bg-yellow-500 text-black' : idx === 1 ? 'bg-zinc-400 text-black' : 'bg-orange-700 text-white'}`}>#{idx + 1}</div>
          <div><p className="text-zinc-200 font-bold text-sm">{client.name}</p></div>
          </div>
          <div className="text-right"><p className="text-emerald-500 font-mono font-bold">{formatCurrency(client.totalSpent)}</p></div>
          </div>
        ))}
        </div>
        </div>
        <div className="bg-zinc-900 border border-zinc-800 p-6 flex flex-col justify-center items-center text-center">
        <Users className="w-12 h-12 text-zinc-700 mb-4" />
        <h3 className="text-white font-bold uppercase">Base de Contatos</h3>
        <Button onClick={() => openModal('client')} variant="primary"><Plus className="w-4 h-4 mr-2 inline" /> Cadastrar Novo</Button>
        </div>
        </div>
        <div className="bg-zinc-900 border border-zinc-800 flex flex-col h-full">
        <div className="p-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-950">
        <h3 className="text-sm font-bold text-zinc-200 uppercase tracking-wider">Lista de Clientes</h3>
        <input type="text" placeholder="Pesquisar..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="bg-zinc-900 border border-zinc-700 text-xs p-1 text-white w-48 rounded-none focus:outline-none focus:border-blue-500" />
        </div>
        <div className="overflow-x-auto">
        <table className="w-full text-sm text-left">
        <thead className="bg-zinc-950 text-zinc-500 uppercase text-xs border-b border-zinc-800">
        <tr><th className="px-6 py-3">Cliente</th><th className="px-6 py-3">Contato</th><th className="px-6 py-3 text-right">Valor Gasto</th><th className="px-6 py-3">A√ß√µes</th></tr>
        </thead>
        <tbody className="divide-y divide-zinc-800">
        {filteredClients.map(client => (
          <tr key={client.id} className="hover:bg-zinc-800/30">
          <td className="px-6 py-4 font-bold text-zinc-300">{client.name}</td>
          <td className="px-6 py-4 text-zinc-400 flex items-center gap-2">
          {client.contact}
          <button onClick={() => sendWhatsApp(client, 'geral')} className="text-zinc-600 hover:text-emerald-500 transition-colors" title="Iniciar Conversa">
          <MessageCircle size={16} />
          </button>
          </td>
          <td className="px-6 py-4 text-right font-mono text-emerald-600">{formatCurrency(client.totalSpent)}</td>
          <td className="px-6 py-4 flex gap-2">
          <Button onClick={() => openModal('client', client)} variant="ghost" className="text-xs px-2 py-1"><Edit size={14}/></Button>
          {user.role === ROLES.ADMIN && <Button onClick={() => deleteData('client', client.id)} variant="danger" className="text-xs px-2 py-1"><Trash2 size={14}/></Button>}
          </td>
          </tr>
        ))}
        </tbody>
        </table>
        </div>
        </div>
        </div>
      );
    };

    const CaixaView = () => {
      if (!cashStatus.isOpen) {
        return (
          <div className="flex flex-col items-center justify-center h-full animate-in fade-in duration-500">
          <div className="bg-zinc-900 border border-zinc-800 p-10 shadow-2xl text-center max-w-md w-full">
          <div className="bg-red-900/20 p-4 rounded-full w-fit mx-auto mb-6">
          <LockKeyhole className="w-12 h-12 text-red-500" />
          </div>
          <h2 className="text-2xl font-bold text-white mb-2 uppercase tracking-wide">Caixa Fechado</h2>
          <p className="text-zinc-500 mb-8 text-sm">Para iniciar as opera√ß√µes, voc√™ precisa abrir o caixa informando o valor em gaveta.</p>
          <Button onClick={() => { setModalType('openCash'); setModalOpen(true); }} variant="primary" className="w-full py-4 text-lg">
          <Unlock className="mr-2 w-5 h-5"/> ABRIR CAIXA AGORA
          </Button>
          </div>
          </div>
        );
      }

      const today = new Date().toISOString().split('T')[0];
      const filteredTransactions = transactions.filter(t => t.date === today);

      const openingTrans = filteredTransactions.find(t => t.category === 'Abertura');
      const openingValue = openingTrans ? openingTrans.value : 0;

      const operationalIn = filteredTransactions.filter(t => t.type === 'in' && t.category !== 'Abertura').reduce((acc, t) => acc + t.value, 0);

      const totalOut = filteredTransactions.filter(t => t.type === 'out').reduce((acc, t) => acc + t.value, 0);

      const currentDrawerBalance = openingValue + operationalIn - totalOut;

      return (
        <div className="space-y-6 animate-in fade-in duration-300">
        <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div className="bg-zinc-900 border border-zinc-800 p-4 flex justify-between items-center relative overflow-hidden">
        <div className="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
        <div><p className="text-[10px] text-zinc-500 uppercase font-bold">Fundo de Caixa</p><p className="text-lg font-mono text-blue-400 mt-1">{formatCurrency(openingValue)}</p></div>
        <Banknote className="text-blue-900 w-6 h-6" />
        </div>

        <div className="bg-zinc-900 border border-zinc-800 p-4 flex justify-between items-center relative overflow-hidden">
        <div className="absolute top-0 left-0 w-1 h-full bg-emerald-500"></div>
        <div><p className="text-[10px] text-zinc-500 uppercase font-bold">Vendas do Dia</p><p className="text-lg font-mono text-emerald-500 mt-1">{formatCurrency(operationalIn)}</p></div>
        <ArrowRightLeft className="text-emerald-900 w-6 h-6 rotate-45" />
        </div>

        <div className="bg-zinc-900 border border-zinc-800 p-4 flex justify-between items-center relative overflow-hidden">
        <div className="absolute top-0 left-0 w-1 h-full bg-red-500"></div>
        <div><p className="text-[10px] text-zinc-500 uppercase font-bold">Sa√≠das</p><p className="text-lg font-mono text-red-500 mt-1">{formatCurrency(totalOut)}</p></div>
        <ArrowRightLeft className="text-red-900 w-6 h-6 -rotate-45" />
        </div>

        <div className="bg-zinc-900 border border-zinc-800 p-4 flex justify-between items-center relative overflow-hidden bg-zinc-800/30">
        <div className="absolute top-0 left-0 w-1 h-full bg-white"></div>
        <div><p className="text-[10px] text-zinc-400 uppercase font-bold">Saldo em Gaveta</p><p className={`text-xl font-mono mt-1 font-bold ${currentDrawerBalance >= 0 ? 'text-white' : 'text-red-500'}`}>{formatCurrency(currentDrawerBalance)}</p></div>
        <Wallet className="text-zinc-600 w-6 h-6" />
        </div>

        <div className="bg-zinc-900 border border-zinc-800 p-2 flex flex-col justify-center gap-2">
        <Button onClick={closeCashDay} variant="secondary" className="w-full h-full border-dashed border-2 border-zinc-700 hover:border-red-800 hover:bg-red-900/20 text-zinc-300 hover:text-red-200 text-xs">
        <LockKeyhole className="mr-2 w-4 h-4"/> FECHAR DIA
        </Button>
        </div>
        </div>

        <div className="bg-zinc-900 border border-zinc-800 flex flex-col h-full">
        <div className="p-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-950">
        <h3 className="text-sm font-bold text-zinc-200 uppercase tracking-wider">Movimenta√ß√µes de Hoje ({new Date().toLocaleDateString('pt-BR')})</h3>
        <div className="flex gap-2">
        <Button onClick={() => { setTempTransaction({ type: 'in', description: '', value: '', category: 'Vendas', method: 'Dinheiro (Gaveta)' }); setModalType('transaction'); setModalOpen(true); }} variant="success" className="text-xs"><Plus size={14} className="mr-1"/> Entrada</Button>
        <Button onClick={() => { setTempTransaction({ type: 'out', description: '', value: '', category: 'Despesas', method: 'Dinheiro (Gaveta)' }); setModalType('transaction'); setModalOpen(true); }} variant="danger" className="text-xs"><Plus size={14} className="mr-1"/> Sa√≠da</Button>
        </div>
        </div>
        <div className="overflow-x-auto">
        <table className="w-full text-sm text-left">
        <thead className="bg-zinc-950 border-b border-zinc-800">
        <tr>
        <th className="px-6 py-3">Descri√ß√£o</th>
        <th className="px-6 py-3">Categoria</th>
        <th className="px-6 py-3">M√©todo</th>
        <th className="px-6 py-3 text-right">Valor</th>
        <th className="px-6 py-3 text-center">Tipo</th>
        <th className="px-6 py-3 text-center">A√ß√µes</th>
        </tr>
        </thead>
        <tbody className="divide-y divide-zinc-800">
        {filteredTransactions.length === 0 ? (
          <tr><td colSpan="6" className="px-6 py-8 text-center text-zinc-600">Nenhuma movimenta√ß√£o hoje.</td></tr>
        ) : (
          filteredTransactions.map(t => (
            <tr key={t.id} className="hover:bg-zinc-800/50">
            <td className="px-6 py-4 font-medium text-zinc-300">{t.description}</td>
            <td className="px-6 py-4 text-zinc-500 text-xs uppercase">{t.category}</td>
            <td className="px-6 py-4 text-zinc-400 text-xs">{t.method || 'N/A'}</td>
            <td className={`px-6 py-4 text-right font-mono font-bold ${t.category === 'Abertura' ? 'text-blue-400' : t.type === 'in' ? 'text-emerald-500' : 'text-red-500'}`}>
            {t.type === 'in' ? '+' : '-'} {formatCurrency(t.value)}
            </td>
            <td className="px-6 py-4 text-center">
            <span className={`px-2 py-1 text-[10px] uppercase font-bold border ${t.type === 'in' ? 'border-emerald-900 text-emerald-500 bg-emerald-900/20' : 'border-red-900 text-red-500 bg-red-900/20'}`}>
            {t.type === 'in' ? 'Entrada' : 'Sa√≠da'}
            </span>
            </td>
            <td className="px-6 py-4 text-center">
            <button onClick={() => deleteData('transaction', t.id)} className="text-zinc-600 hover:text-red-500"><Trash2 size={14}/></button>
            </td>
            </tr>
          ))
        )}
        </tbody>
        </table>
        </div>
        </div>
        </div>
      );
    };

    const VendasView = () => {
      const filteredOrders = orders.filter(o => o.client.toLowerCase().includes(searchTerm.toLowerCase()) || o.id.toString().includes(searchTerm));
      const selectedService = services.find(p => p.id === parseInt(calcData.serviceId));

      const selectedInventoryItem = inventory.find(i => i.id === parseInt(productSaleData.inventoryId));

      return (
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 animate-in fade-in slide-in-from-right-4 duration-300">
        <div className="lg:col-span-5 bg-zinc-900 border border-zinc-800 flex flex-col h-fit">
        <div className="flex border-b border-zinc-800">
        <button
        onClick={() => setSaleTab('service')}
        className={`flex-1 py-3 text-sm font-bold uppercase tracking-wider flex items-center justify-center gap-2 ${saleTab === 'service' ? 'bg-blue-900/20 text-blue-400 border-b-2 border-blue-500' : 'text-zinc-500 hover:text-zinc-300'}`}
        >
        <Calculator size={16}/> Produ√ß√£o
        </button>
        <button
        onClick={() => setSaleTab('product')}
        className={`flex-1 py-3 text-sm font-bold uppercase tracking-wider flex items-center justify-center gap-2 ${saleTab === 'product' ? 'bg-emerald-900/20 text-emerald-400 border-b-2 border-emerald-500' : 'text-zinc-500 hover:text-zinc-300'}`}
        >
        <ShoppingBag size={16}/> Revenda
        </button>
        </div>

        <div className="p-6 space-y-6">

        {saleTab === 'service' && (
          <>
          <div className="grid grid-cols-2 gap-4">
          <Input label="Largura Item (cm)" placeholder="Ex: 9" type="number" value={calcData.itemW} onChange={e => setCalcData({...calcData, itemW: e.target.value})} />
          <Input label="Altura Item (cm)" placeholder="Ex: 5" type="number" value={calcData.itemH} onChange={e => setCalcData({...calcData, itemH: e.target.value})} />
          </div>
          <div className="grid grid-cols-2 gap-4">
          <div className="flex flex-col gap-1 w-full">
          <label className="text-xs uppercase text-zinc-500 font-bold tracking-wider mb-1">Servi√ßo de Venda</label>
          <select className="bg-zinc-950 border border-zinc-700 text-zinc-200 p-2 rounded-none focus:border-blue-700 focus:outline-none font-mono text-sm h-[38px] w-full" value={calcData.serviceId} onChange={e => setCalcData({...calcData, serviceId: e.target.value, selectedExtras: []})}>
          <option value="">Selecione...</option>
          {services.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
          </select>
          </div>
          <Input label="Quantidade Total" placeholder="Ex: 1000" type="number" value={calcData.quantity} onChange={e => setCalcData({...calcData, quantity: e.target.value})} />
          </div>

          {selectedService && selectedService.extras && selectedService.extras.length > 0 && (
            <div className="bg-zinc-950 p-4 border border-zinc-800">
            <p className="text-xs uppercase text-zinc-500 font-bold mb-2 flex items-center gap-1"><Scissors size={12}/> Adicionais Dispon√≠veis</p>
            <div className="grid grid-cols-2 gap-2">
            {selectedService.extras.map(extra => (
              <label key={extra.id} className={`flex items-center gap-2 p-2 border cursor-pointer transition-colors ${calcData.selectedExtras?.includes(extra.id) ? 'border-emerald-600 bg-emerald-900/10' : 'border-zinc-700 hover:border-zinc-600'}`}>
              <input type="checkbox" checked={calcData.selectedExtras?.includes(extra.id) || false} onChange={() => toggleExtraSelection(extra.id)} className="accent-emerald-500 w-4 h-4"/>
              <div className="flex flex-col"><span className="text-sm text-zinc-200">{extra.name}</span><span className="text-xs text-emerald-500 font-mono">+{formatCurrency(extra.value)}/fl</span></div>
              </label>
            ))}
            </div>
            </div>
          )}

          <div className="grid grid-cols-2 gap-4">
          <Input label="Acabamento Extra" placeholder="0.00" type="number" value={calcData.finishCost} onChange={e => setCalcData({...calcData, finishCost: e.target.value})} />
          <div className="flex flex-col gap-1 w-full">
          <label className="text-xs uppercase text-zinc-500 font-bold tracking-wider mb-1">Prazo de Entrega</label>
          <select className="bg-zinc-950 border border-zinc-700 text-zinc-200 p-2 rounded-none focus:border-blue-700 focus:outline-none font-mono text-sm h-[38px] w-full" value={calcData.deliveryTime} onChange={e => setCalcData({...calcData, deliveryTime: e.target.value})}>
          <option value="1 dia √∫til">1 dia √∫til</option>
          <option value="2 dias √∫teis">2 dias √∫teis</option>
          <option value="3 dias √∫teis">3 dias √∫teis</option>
          <option value="5 dias √∫teis">5 dias √∫teis</option>
          </select>
          </div>
          </div>

          <div className="grid grid-cols-1 gap-4">
          <Input label="Desconto Especial (R$)" placeholder="0.00" type="number" value={calcData.discount} onChange={e => setCalcData({...calcData, discount: e.target.value})} />
          </div>

          <Button onClick={calculateBudget} className="w-full py-3" variant="secondary">Calcular Item</Button>

          {calcResult && (
            <div className="bg-zinc-950 border border-zinc-800 p-4 mt-4 animate-in zoom-in-95 duration-200">
            <div className="space-y-1 mb-4 border-b border-zinc-800 pb-4">
            <div className="flex justify-between items-center text-zinc-500 text-xs"><span>Aproveitamento:</span><span className="text-zinc-300 font-bold font-mono">{calcResult.fit} un/fl</span></div>
            <div className="flex justify-between items-center text-zinc-500 text-xs"><span>Total de Folhas:</span><span className="text-zinc-300 font-bold font-mono">{calcResult.totalSheets} fl</span></div>
            <div className="flex justify-between items-center text-zinc-500 text-xs"><span>Valor das Folhas:</span><span className="text-zinc-300 font-bold font-mono">{formatCurrency(calcResult.baseSheetsPrice)}</span></div>
            {calcResult.extrasPrice > 0 && <div className="flex justify-between items-center text-zinc-500 text-xs"><span>Valor dos Extras:</span><span className="text-emerald-500 font-bold font-mono">{formatCurrency(calcResult.extrasPrice)}</span></div>}
            </div>

            {calcResult.discount > 0 && <div className="flex justify-between items-center mb-2 text-red-400 text-xs"><span>Desconto Aplicado:</span><span>- {formatCurrency(calcResult.discount)}</span></div>}

            <div className="text-center bg-zinc-900 p-3 border border-zinc-800 mb-4">
            <p className="text-xs uppercase text-zinc-500 mb-1">Valor Total do Item</p>
            <p className="text-3xl font-black text-white tracking-tight">{formatCurrency(calcResult.finalPrice)}</p>
            </div>

            <Button onClick={addToCart} variant="primary" className="w-full">
            <Plus className="w-4 h-4 mr-2"/> Adicionar ao Pedido
            </Button>
            </div>
          )}
          </>
        )}

        {saleTab === 'product' && (
          <div className="animate-in fade-in slide-in-from-left-2">
          <div className="flex flex-col gap-1 w-full mb-4">
          <label className="text-xs uppercase text-zinc-500 font-bold tracking-wider mb-1">Selecione o Produto (Estoque)</label>
          <select
          className="bg-zinc-950 border border-zinc-700 text-zinc-200 p-2 rounded-none focus:border-emerald-700 focus:outline-none font-mono text-sm h-[38px] w-full"
          value={productSaleData.inventoryId}
          onChange={e => {
            const id = e.target.value;
            const item = inventory.find(i => i.id === parseInt(id));
            setProductSaleData({
              ...productSaleData,
              inventoryId: id,
              unitPrice: item ? (item.sellPrice || item.price) : ''
            })
          }}
          >
          <option value="">Selecione...</option>
          {inventory.filter(i => i.quantity > 0).map(i => <option key={i.id} value={i.id}>{i.name} (Disp: {i.quantity})</option>)}
          </select>
          </div>

          <div className="grid grid-cols-2 gap-4">
          <Input label="Quantidade" placeholder="Ex: 1" type="number" value={productSaleData.quantity} onChange={e => setProductSaleData({...productSaleData, quantity: e.target.value})} />
          <Input label="Valor Unit√°rio (Venda)" placeholder="0.00" type="number" value={productSaleData.unitPrice} onChange={e => setProductSaleData({...productSaleData, unitPrice: e.target.value})} />
          </div>

          {selectedInventoryItem && (
            <div className="mb-4 text-xs text-zinc-500">
            Custo cadastrado: <span className="text-zinc-300 font-mono">{formatCurrency(selectedInventoryItem.price)}</span>
            </div>
          )}

          {productSaleData.quantity && productSaleData.unitPrice && (
            <div className="bg-zinc-950 border border-zinc-800 p-4 mt-4">
            <div className="text-center mb-4">
            <p className="text-xs uppercase text-zinc-500 mb-1">Total do Produto</p>
            <p className="text-3xl font-black text-white tracking-tight">{formatCurrency(productSaleData.quantity * productSaleData.unitPrice)}</p>
            </div>
            <Button onClick={addProductToCart} variant="success" className="w-full">
            <Plus className="w-4 h-4 mr-2"/> Adicionar ao Pedido
            </Button>
            </div>
          )}
          </div>
        )}

        </div>
        </div>

        <div className="lg:col-span-7 space-y-6">

        {cart.length > 0 && (
          <div className="bg-zinc-900 border border-zinc-800 flex flex-col mb-6 animate-in slide-in-from-top-4">
          <div className="p-4 border-b border-zinc-800 bg-blue-900/20 flex justify-between items-center">
          <h3 className="text-sm font-bold text-blue-200 uppercase tracking-wider flex items-center gap-2"><ListPlus size={16}/> Itens do Novo Pedido</h3>
          <span className="bg-blue-600 text-white text-xs px-2 py-1 font-bold rounded">{cart.length}</span>
          </div>
          <div className="p-4 space-y-2 max-h-[300px] overflow-y-auto">
          {cart.map(item => (
            <div key={item._id} className="flex justify-between items-center bg-zinc-950 p-3 border border-zinc-800">
            <div>
            <div className="text-sm font-bold text-white flex items-center gap-2">
            {item.isProduct && <Tag size={12} className="text-emerald-500"/>}
            {item.serviceName}
            </div>
            <p className="text-xs text-zinc-500">{item.description}</p>
            </div>
            <div className="flex items-center gap-3">
            <p className="font-mono text-emerald-500 font-bold">{formatCurrency(item.finalPrice)}</p>
            <button onClick={() => removeFromCart(item._id)} className="text-zinc-600 hover:text-red-500"><Trash2 size={16}/></button>
            </div>
            </div>
          ))}
          </div>
          <div className="p-4 border-t border-zinc-800 bg-zinc-950">
          <div className="flex justify-between items-center mb-4">
          <span className="text-zinc-400 uppercase text-xs font-bold">Total do Or√ßamento</span>
          <span className="text-2xl text-white font-bold font-mono">{formatCurrency(cart.reduce((acc, i) => acc + i.finalPrice, 0))}</span>
          </div>
          <div className="flex flex-col gap-2">
          <select className="bg-zinc-900 border border-zinc-700 text-zinc-200 p-2 text-sm w-full rounded-none focus:border-blue-700 outline-none" value={selectedClientId} onChange={(e) => setSelectedClientId(e.target.value)}>
          <option value="">Selecione o Cliente...</option>
          {clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
          </select>
          <Button onClick={handleCreateOrder} variant="success" className="w-full py-3">Fechar Or√ßamento e Gerar Pedido</Button>
          </div>
          </div>
          </div>
        )}

        <div className="bg-zinc-900 border border-zinc-800 flex flex-col h-full">
        <div className="p-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-950">
        <h3 className="text-sm font-bold text-zinc-200 uppercase tracking-wider">Hist√≥rico de Pedidos</h3>
        <input type="text" placeholder="Buscar ID ou Cliente..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="bg-zinc-900 border border-zinc-700 text-xs p-1 text-white w-48 rounded-none focus:outline-none focus:border-blue-500" />
        </div>
        <div className="overflow-auto max-h-[500px]">
        <table className="w-full text-sm text-left">
        <thead className="bg-zinc-950 sticky top-0 z-10">
        <tr><th className="px-4 py-3">Pedido</th><th className="px-4 py-3">Cliente</th><th className="px-4 py-3 text-right">Valor</th><th className="px-4 py-3 text-center">A√ß√µes</th></tr>
        </thead>
        <tbody className="divide-y divide-zinc-800">
        {filteredOrders.map(order => (
          <tr key={order.id} className="hover:bg-zinc-800/50 group">
          <td className="px-4 py-3"><div className="font-mono text-zinc-300 font-bold">#{order.id}</div><Badge status={order.status} /></td>
          <td className="px-4 py-3"><div className="text-zinc-300 font-medium">{order.client}</div><div className="text-xs text-zinc-500 truncate max-w-[150px]">{order.description}</div></td>
          <td className="px-4 py-3 font-mono text-zinc-300 text-right">
          {formatCurrency(order.value)}
          {order.paidAmount > 0 && <div className="text-[10px] text-emerald-500 mt-1">Pago: {formatCurrency(order.paidAmount)}</div>}
          </td>
          <td className="px-4 py-3 flex gap-1 items-center justify-center">
          {/* Bot√µes contextuais por status */}
          {order.status === 'orcamento' && (
            <>
            <Button onClick={() => handleEditOrder(order)} variant="ghost" className="px-1 py-1" title="Editar"><Edit size={14}/></Button>
            <Button onClick={() => sendWhatsApp(order, 'orcamento')} variant="whatsapp" className="px-2 py-1" title="Enviar Or√ßamento"><MessageCircle size={14}/></Button>
            <Button onClick={() => { setOrders(orders.map(o => o.id === order.id ? { ...o, status: 'aguardando_pagamento' } : o)); showToast("Aprovado!"); }} variant="success" className="px-2 py-1" title="Aprovar"><CheckCircle size={14}/></Button>
            </>
          )}

          {order.status === 'aguardando_pagamento' && (
            <Button onClick={() => sendWhatsApp(order, 'sinal')} variant="whatsapp" className="px-2 py-1" title="Cobrar Sinal"><DollarSign size={14}/></Button>
          )}

          <Button onClick={() => { setEditingItem(order); setModalType('orderDetail'); setModalOpen(true); }} variant="secondary" className="px-2 py-1"><Eye size={14}/></Button>

          {order.status === 'aguardando_pagamento' && (
            <Button
            onClick={() => openPaymentModal(order, 'signal')}
            variant="success"
            className="px-3 py-1 text-xs flex items-center gap-1 font-bold"
            title="Lan√ßar pagamento no Caixa"
            >
            <Wallet size={14}/> Receber no Caixa
            </Button>
          )}

          {!order.paid && order.paidAmount > 0 && order.status !== 'orcamento' && order.status !== 'aguardando_pagamento' && (
            <Button
            onClick={() => openPaymentModal(order, 'remaining')}
            variant="primary"
            className="px-3 py-1 text-xs flex items-center gap-1"
            title="Receber valor restante"
            >
            <Banknote size={14}/> Receber Restante
            </Button>
          )}

          <Button onClick={() => deleteData('order', order.id)} variant="ghost" className="px-1 py-1 hover:text-red-500"><Trash2 size={14}/></Button>
          </td>
          </tr>
        ))}
        </tbody>
        </table>
        </div>
        </div>
        </div>
        </div>
      );
    };

    const FinanceiroView = () => {
      const currentDate = new Date();
      const currentMonth = currentDate.getMonth();
      const currentYear = currentDate.getFullYear();

      const monthTransactions = transactions.filter(t => {
        const d = new Date(t.date);
        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
      });

      const monthIn = monthTransactions.filter(t => t.type === 'in' && t.category !== 'Abertura').reduce((acc, t) => acc + t.value, 0);
      const monthOut = monthTransactions.filter(t => t.type === 'out').reduce((acc, t) => acc + t.value, 0);
      const monthBalance = monthIn - monthOut;

      const weekData = [];
      for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const dateStr = d.toISOString().split('T')[0];
        const dayTotal = transactions
        .filter(t => t.date === dateStr && t.type === 'in' && t.category !== 'Abertura')
        .reduce((acc, t) => acc + t.value, 0);
        weekData.push({ day: d.toLocaleDateString('pt-BR', { weekday: 'short' }), value: dayTotal });
      }
      const maxWeekValue = Math.max(...weekData.map(d => d.value), 1);

      const pendingBills = bills.filter(b => b.status !== 'pago').sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));

      return (
        <div className="space-y-8 animate-in fade-in duration-300">
        {/* DASHBOARD PRINCIPAL (OPERACIONAL) */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div className="bg-zinc-900 border border-zinc-800 p-6 shadow-lg">
        <p className="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-2">Entradas Operacionais (Vendas)</p>
        <p className="text-3xl font-mono text-emerald-500 font-bold">{formatCurrency(monthIn)}</p>
        </div>
        <div className="bg-zinc-900 border border-zinc-800 p-6 shadow-lg">
        <p className="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-2">Sa√≠das Operacionais (Gastos)</p>
        <p className="text-3xl font-mono text-red-500 font-bold">{formatCurrency(monthOut)}</p>
        </div>
        <div className="bg-zinc-900 border border-zinc-800 p-6 shadow-lg">
        <p className="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-2">Lucro L√≠quido (M√™s)</p>
        <p className={`text-3xl font-mono font-bold ${monthBalance >= 0 ? 'text-blue-500' : 'text-red-500'}`}>{formatCurrency(monthBalance)}</p>
        </div>
        {/* Gr√°fico Semanal */}
        <div className="bg-zinc-900 border border-zinc-800 p-4 flex items-end justify-between gap-1 shadow-lg">
        {weekData.map((d, i) => (
          <div key={i} className="flex flex-col items-center w-full gap-1 group relative">
          <div className="w-full bg-emerald-900/30 hover:bg-emerald-600 transition-all rounded-t-sm relative" style={{ height: `${(d.value / maxWeekValue) * 60}px`, minHeight: '4px' }}>
          <div className="absolute -top-6 left-1/2 -translate-x-1/2 bg-black text-white text-[10px] px-1 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">{formatCurrency(d.value)}</div>
          </div>
          <span className="text-[10px] text-zinc-500 uppercase">{d.day}</span>
          </div>
        ))}
        </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* LISTA DE FECHAMENTOS (CAIXA F√çSICO/GAVETA) */}
        <div className="bg-zinc-900 border border-zinc-800 flex flex-col">
        <div className="p-4 border-b border-zinc-800 bg-zinc-950 flex items-center gap-2">
        <CalendarDays className="w-5 h-5 text-zinc-400" />
        <h3 className="text-sm font-bold text-zinc-200 uppercase tracking-wider">Hist√≥rico de Fechamentos</h3>
        </div>
        <div className="divide-y divide-zinc-800 max-h-[400px] overflow-y-auto">
        {cashClosings.length === 0 ? (
          <div className="p-8 text-center text-zinc-600 italic">Nenhum fechamento de caixa registrado ainda.</div>
        ) : (
          cashClosings.map(closing => (
            <div key={closing.id} className="group">
            <div
            className="p-4 flex items-center justify-between hover:bg-zinc-800/30 cursor-pointer transition-colors"
            onClick={() => setExpandedDay(expandedDay === closing.id ? null : closing.id)}
            >
            <div className="flex items-center gap-4">
            <div className="bg-zinc-800 p-2 rounded-none border border-zinc-700">
            <p className="text-xs font-bold text-zinc-400 uppercase text-center">{new Date(closing.date).toLocaleDateString('pt-BR', { month: 'short' })}</p>
            <p className="text-xl font-bold text-white text-center leading-none">{new Date(closing.date).toLocaleDateString('pt-BR', { day: '2-digit' })}</p>
            </div>
            <div>
            <p className="text-sm font-bold text-zinc-200">Fechamento do Dia</p>
            <p className="text-xs text-zinc-500">Resp: {closing.closedBy}</p>
            </div>
            </div>
            <div className="text-right">
            <p className="text-xs text-zinc-500 uppercase">Saldo Final</p>
            <p className={`text-base font-mono font-bold ${closing.balance >= 0 ? 'text-white' : 'text-red-400'}`}>{formatCurrency(closing.balance)}</p>
            </div>
            </div>

            {expandedDay === closing.id && (
              <div className="bg-black/20 p-4 border-t border-zinc-800 border-b-2 border-b-zinc-800 animate-in slide-in-from-top-2">
              <div className="grid grid-cols-1 gap-2">
              <p className="text-xs text-zinc-500">Fundo: {formatCurrency(closing.openingBalance)} | Entradas: {formatCurrency(closing.operationalIn)} | Sa√≠das: {formatCurrency(closing.totalOut)}</p>
              </div>
              </div>
            )}
            </div>
          ))
        )}
        </div>
        </div>

        {/* CONTAS A PAGAR */}
        <div className="bg-zinc-900 border border-zinc-800 flex flex-col">
        <div className="p-4 border-b border-zinc-800 bg-zinc-950 flex items-center justify-between">
        <div className="flex items-center gap-2">
        <CalendarClock className="w-5 h-5 text-red-400" />
        <h3 className="text-sm font-bold text-zinc-200 uppercase tracking-wider">Contas a Pagar</h3>
        </div>
        <Button onClick={() => openModal('bill')} variant="secondary" className="px-2 py-1 text-xs h-8"><Plus size={14} className="mr-1"/> Nova Conta</Button>
        </div>
        <div className="divide-y divide-zinc-800 max-h-[400px] overflow-y-auto">
        {pendingBills.length === 0 ? (
          <div className="p-8 text-center text-zinc-600 italic">Nenhuma conta pendente para pagamento.</div>
        ) : (
          pendingBills.map(bill => {
            const isOverdue = new Date(bill.dueDate) < new Date(new Date().setHours(0,0,0,0));
            return (
              <div key={bill.id} className="p-4 flex items-center justify-between hover:bg-zinc-800/30 group">
              <div className="flex flex-col gap-1">
              <div className="flex items-center gap-2">
              <span className="font-bold text-zinc-200">{bill.description}</span>
              {isOverdue && <span className="flex items-center gap-1 text-[10px] bg-red-900/50 text-red-200 px-1.5 py-0.5 rounded border border-red-800 font-bold uppercase"><AlertCircle size={10}/> Vencida</span>}
              </div>
              <div className="flex items-center gap-2 text-xs text-zinc-500">
              <span className="bg-zinc-800 px-1.5 rounded text-zinc-400 border border-zinc-700">{bill.category}</span>
              <span className={isOverdue ? 'text-red-400 font-bold' : ''}>Vence: {formatDate(bill.dueDate)}</span>
              </div>
              </div>
              <div className="flex items-center gap-4">
              <span className="font-mono text-white font-bold">{formatCurrency(bill.value)}</span>
              <div className="flex gap-1">
              <button onClick={() => payBill(bill)} className="p-2 bg-emerald-900/20 hover:bg-emerald-600 border border-emerald-900 text-emerald-500 hover:text-white transition-all rounded" title="Pagar Agora">
              <Check size={16} strokeWidth={3}/>
              </button>
              <button onClick={() => { setEditingItem(bill); openModal('bill', bill); }} className="p-2 hover:bg-zinc-700 text-zinc-500 hover:text-white transition-colors rounded">
              <Edit size={16}/>
              </button>
              <button onClick={() => deleteData('bill', bill.id)} className="p-2 hover:bg-red-900/30 text-zinc-500 hover:text-red-500 transition-colors rounded">
              <Trash2 size={16}/>
              </button>
              </div>
              </div>
              </div>
            );
          })
        )}
        </div>
        <div className="p-3 bg-zinc-950 border-t border-zinc-800 text-right">
        <span className="text-xs text-zinc-500 uppercase mr-2">Total Pendente:</span>
        <span className="text-white font-mono font-bold">{formatCurrency(pendingBills.reduce((acc, b) => acc + b.value, 0))}</span>
        </div>
        </div>
        </div>
        </div>
      );
    };

    const ProducaoView = () => {
      // Filtra apenas ordens ativas na produ√ß√£o
      const activeOrders = orders.filter(o => ['producao', 'acabamento', 'concluido'].includes(o.status));

      // Fun√ß√£o de cor de urg√™ncia
      const getUrgencyColor = (deliveryDate) => {
        if (!deliveryDate) return "border-l-zinc-600";
        const now = new Date();
        const delivery = new Date(deliveryDate);
        const diffInHours = (delivery - now) / (1000 * 60 * 60);

        if (diffInHours < 0) return "border-l-zinc-500 bg-red-900/10"; // Atrasado
        if (diffInHours < 24) return "border-l-red-500"; // Cr√≠tico
        if (diffInHours < 48) return "border-l-orange-500"; // Aten√ß√£o
        return "border-l-emerald-500"; // Tranquilo
      };

      // L√≥gica de Ordena√ß√£o e Filtro usando as vari√°veis do topo (prodFilter)
      const filteredList = activeOrders
      .filter(o => prodFilter === 'all' || o.status === prodFilter)
      .sort((a, b) => {
        if (!a.deliveryDate) return 1;
        if (!b.deliveryDate) return -1;
        return new Date(a.deliveryDate) - new Date(b.deliveryDate);
      });

      // M√©tricas
      const countCritical = activeOrders.filter(o => getUrgencyColor(o.deliveryDate).includes('red')).length;
      const countFinishing = activeOrders.filter(o => o.status === 'acabamento').length;
      const countProduction = activeOrders.filter(o => o.status === 'producao').length;
      const countDone = activeOrders.filter(o => o.status === 'concluido').length;
      const getProgress = (order) => {
        const steps = order.productionSteps || [];
        if (steps.length === 0) return 0;
        const done = steps.filter(s => s.done).length;
        return Math.round((done / steps.length) * 100);
      };

      return (
        <div className="space-y-6 animate-in fade-in duration-300">

        {/* 1. DASHBOARD DE M√âTRICAS */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="bg-zinc-900 border border-zinc-800 p-4 flex items-center gap-3">
        <div className="p-3 bg-blue-900/20 rounded text-blue-400"><ListPlus size={20}/></div>
        <div><p className="text-2xl font-bold text-white">{activeOrders.length}</p><p className="text-xs text-zinc-500 uppercase">Total na Fila</p></div>
        </div>
        <div className="bg-zinc-900 border border-zinc-800 p-4 flex items-center gap-3">
        <div className="p-3 bg-red-900/20 rounded text-red-400"><AlertCircle size={20}/></div>
        <div><p className="text-2xl font-bold text-white">{countCritical}</p><p className="text-xs text-zinc-500 uppercase">Urgentes/Atrasados</p></div>
        </div>
        <div className="bg-zinc-900 border border-zinc-800 p-4 flex items-center gap-3">
        <div className="p-3 bg-zinc-800 rounded text-zinc-400"><Printer size={20}/></div>
        <div><p className="text-2xl font-bold text-white">{countProduction}</p><p className="text-xs text-zinc-500 uppercase">Em Impress√£o</p></div>
        </div>
        <div className="bg-zinc-900 border border-zinc-800 p-4 flex items-center gap-3">
        <div className="p-3 bg-purple-900/20 rounded text-purple-400"><Scissors size={20}/></div>
        <div><p className="text-2xl font-bold text-white">{countFinishing}</p><p className="text-xs text-zinc-500 uppercase">Em Acabamento</p></div>
        </div>
        </div>

        {/* 2. BARRA DE CONTROLE E FILTROS */}
        <div className="flex flex-col md:flex-row justify-between items-center bg-zinc-900 border border-zinc-800 p-1">
        <div className="flex">
        <button onClick={() => setProdFilter('all')} className={`px-4 py-2 text-sm font-bold uppercase transition-colors ${prodFilter === 'all' ? 'bg-zinc-800 text-white' : 'text-zinc-500 hover:text-zinc-300'}`}>Todos</button>

        <button onClick={() => setProdFilter('producao')} className={`px-4 py-2 text-sm font-bold uppercase transition-colors ${prodFilter === 'producao' ? 'bg-zinc-800 text-blue-400' : 'text-zinc-500 hover:text-zinc-300'}`}>Impress√£o</button>

        <button onClick={() => setProdFilter('acabamento')} className={`px-4 py-2 text-sm font-bold uppercase transition-colors ${prodFilter === 'acabamento' ? 'bg-zinc-800 text-purple-400' : 'text-zinc-500 hover:text-zinc-300'}`}>Acabamento</button>

        {/* [NOVO] Bot√£o de Finalizados */}
        <button onClick={() => setProdFilter('concluido')} className={`px-4 py-2 text-sm font-bold uppercase transition-colors ${prodFilter === 'concluido' ? 'bg-zinc-800 text-emerald-400' : 'text-zinc-500 hover:text-zinc-300'}`}>Finalizados</button>
        </div>

        <div className="px-4 py-2 text-xs text-zinc-500 font-mono hidden md:block">
        Ordenado por: <span className="text-emerald-500">Prioridade de Entrega</span>
        </div>
        </div>
        // ...

        {/* 3. LISTA DE TRABALHOS */}
        <div className="space-y-2">
        {filteredList.length === 0 ? (
          <div className="p-10 text-center border-2 border-dashed border-zinc-800 text-zinc-600 uppercase tracking-widest">
          Nenhum trabalho nesta etapa
          </div>
        ) : filteredList.map(order => {
          const progress = getProgress(order);
          const isExpanded = expandedOP === order.id;

          return (
            <div key={order.id} className={`bg-zinc-900 border border-zinc-800 border-l-4 transition-all duration-200 ${getUrgencyColor(order.deliveryDate)}`}>

            {/* CABE√áALHO DO ITEM */}
            <div
            className="p-4 flex flex-col md:flex-row items-center gap-4 cursor-pointer hover:bg-zinc-800/50"
            onClick={() => setExpandedOP(isExpanded ? null : order.id)}
            >
            <div className="flex items-center gap-4 flex-1 w-full">
            <div className="flex flex-col items-center justify-center w-12 text-center">
            <span className="text-[10px] uppercase text-zinc-500 font-bold">OP</span>
            <span className="text-sm font-mono font-bold text-white">#{order.id}</span>
            </div>
            <div className="flex flex-col flex-1">
            <div className="flex items-center gap-2 mb-1">
            <h3 className="font-bold text-white text-lg">{order.client}</h3>
            <Badge status={order.status} />
            </div>
            <p className="text-xs text-zinc-400 truncate max-w-md">{order.description}</p>
            </div>
            </div>

            {/* Progresso Mini */}
            <div className="w-full md:w-32 flex flex-col gap-1">
            <div className="flex justify-between text-[10px] text-zinc-500 uppercase font-bold">
            <span>Progresso</span>
            <span>{progress}%</span>
            </div>
            <div className="h-1.5 w-full bg-zinc-800 rounded-full overflow-hidden">
            <div className="h-full bg-blue-500 transition-all duration-500" style={{ width: `${progress}%` }}></div>
            </div>
            </div>

            {/* Data Entrega */}
            <div className="w-full md:w-auto text-right min-w-[120px]">
            <div className="text-[10px] text-zinc-500 uppercase font-bold">Entrega Prevista</div>
            <div className="text-sm font-mono font-bold text-zinc-200 flex items-center justify-end gap-2">
            <Clock size={14} className={getUrgencyColor(order.deliveryDate).includes('red') ? 'text-red-500 animate-pulse' : 'text-zinc-600'}/>
            {order.deliveryTime || 'S/ Data'}
            </div>
            </div>

            <div className="text-zinc-500">
            {isExpanded ? <ChevronUp size={20}/> : <ChevronDown size={20}/>}
            </div>
            </div>

            {/* √ÅREA EXPANDIDA */}
            {isExpanded && (
              <div className="border-t border-zinc-800 bg-zinc-950/50 p-6 animate-in slide-in-from-top-2">
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">

              {/* COLUNA 1: CHECKLIST */}
              <div className="lg:col-span-1 border-r border-zinc-800 pr-0 lg:pr-6">
              <h4 className="text-xs font-bold text-zinc-400 uppercase mb-4 flex items-center gap-2"><CheckSquare size={14}/> Checklist de Etapas</h4>
              <div className="space-y-2">
              {(order.productionSteps || PRODUCTION_STEPS_TEMPLATE).map(step => (
                <button
                key={step.id}
                onClick={(e) => { e.stopPropagation(); toggleProductionStep(order.id, step.id); }}
                className={`w-full flex items-center justify-between p-3 border text-left transition-colors ${step.done ? 'bg-emerald-900/20 border-emerald-900/50' : 'bg-zinc-900 border-zinc-800 hover:border-zinc-700'}`}
                >
                <span className={`text-sm ${step.done ? 'text-emerald-400 line-through decoration-emerald-900' : 'text-zinc-300'}`}>{step.label}</span>
                {step.done ? <CheckCircle size={16} className="text-emerald-500"/> : <div className="w-4 h-4 rounded-full border border-zinc-600"></div>}
                </button>
              ))}
              </div>
              </div>

              {/* COLUNA 2: HIST√ìRICO */}
              <div className="lg:col-span-1">
              <h4 className="text-xs font-bold text-zinc-400 uppercase mb-4 flex items-center gap-2"><Activity size={14}/> Hist√≥rico Recente</h4>
              <div className="relative border-l border-zinc-800 ml-2 pl-4 space-y-4 h-[200px] overflow-y-auto">
              {(order.history || []).slice().reverse().map((h, i) => (
                <div key={i} className="relative">
                <div className="absolute -left-[21px] top-1.5 w-2 h-2 rounded-full bg-zinc-700"></div>
                <p className="text-[10px] text-zinc-500">{formatDateTime(h.date)}</p>
                <p className="text-sm text-zinc-300">{h.action}</p>
                <p className="text-[10px] text-zinc-600 italic">por {h.user}</p>
                </div>
              ))}
              </div>
              </div>

              {/* COLUNA 3: A√á√ïES */}
              <div className="lg:col-span-1 flex flex-col justify-between h-full">
              <div>
              <h4 className="text-xs font-bold text-zinc-400 uppercase mb-4 flex items-center gap-2"><Settings size={14}/> A√ß√µes do Pedido</h4>
              <div className="grid grid-cols-1 gap-3">
              <Button variant="secondary" onClick={() => handlePrintOP(order)} className="justify-start"><Printer size={16} className="mr-2"/> Imprimir Ordem (PDF)</Button>
              <Button variant="whatsapp" onClick={() => sendWhatsApp(order, 'andamento')} className="justify-start"><MessageCircle size={16} className="mr-2"/> Notificar Cliente</Button>
              <Button variant="outline" onClick={() => { setEditingItem(order); setModalType('productionManage'); setModalOpen(true); }} className="justify-start"><Edit size={16} className="mr-2"/> Editar Detalhes / Notas</Button>
              </div>
              </div>

              <div className="mt-6 pt-6 border-t border-zinc-800">
              <p className="text-xs text-zinc-500 uppercase mb-2">Mover Est√°gio</p>
              {order.status === 'producao' ? (
                <Button variant="primary" className="w-full py-4 shadow-lg shadow-blue-900/20" onClick={() => { setOrders(orders.map(o => o.id === order.id ? {...o, status: 'acabamento'} : o)); showToast("Movido para Acabamento"); }}>
                <ArrowRightLeft size={18} className="mr-2"/> Mover para ACABAMENTO
                </Button>
              ) : (
                <Button variant="success" className="w-full py-4 shadow-lg shadow-emerald-900/20" onClick={() => { setOrders(orders.map(o => o.id === order.id ? {...o, status: 'concluido'} : o)); showToast("Pedido Finalizado!"); }}>
                <CheckCircle size={18} className="mr-2"/> CONCLUIR PEDIDO
                </Button>
              )}
              </div>
              </div>

              </div>
              </div>
            )}
            </div>
          );
        })}
        </div>
        </div>
      );
    };

    const EstoqueView = () => {
      const showCosts = user.role === ROLES.ADMIN;
      const filteredInventory = inventory.filter(item => {
        const matchSearch = item.name.toLowerCase().includes(searchTerm.toLowerCase());
        if (inventoryFilter === 'all') return matchSearch;
        if (inventoryFilter === 'low') return matchSearch && item.quantity <= item.minStock;
        return matchSearch && item.category === inventoryFilter;
      });
      const totalValue = inventory.reduce((acc, curr) => acc + (curr.quantity * curr.price), 0);
      return (
        <div className="space-y-6 animate-in fade-in duration-300">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className="bg-zinc-900 border border-zinc-800 p-4 flex items-center justify-between">
        <div><p className="text-xs text-zinc-500 uppercase font-bold">Valor em Estoque</p><p className="text-2xl font-mono text-emerald-500 mt-1">{formatCurrency(totalValue)}</p></div>
        <DollarSign className="text-zinc-700 w-8 h-8" />
        </div>
        <div className="bg-zinc-900 border border-zinc-800 p-4 flex items-center justify-between">
        <div><p className="text-xs text-zinc-500 uppercase font-bold">Total de Itens</p><p className="text-2xl font-mono text-blue-500 mt-1">{inventory.length}</p></div>
        <Package className="text-zinc-700 w-8 h-8" />
        </div>
        </div>
        <div className="bg-zinc-900 border border-zinc-800 flex flex-col h-full">
        <div className="p-4 border-b border-zinc-800 flex flex-col md:flex-row justify-between items-center bg-zinc-950 gap-4">
        <div><h2 className="text-xl font-bold text-white uppercase tracking-wider">Estoque</h2></div>
        <div className="flex gap-2">
        <input type="text" placeholder="Buscar..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="bg-zinc-900 border border-zinc-700 text-xs p-2 text-white w-40 rounded-none focus:outline-none focus:border-blue-500" />
        <select value={inventoryFilter} onChange={e => setInventoryFilter(e.target.value)} className="bg-zinc-900 border border-zinc-700 text-xs p-2 text-white rounded-none focus:outline-none focus:border-blue-500">
        <option value="all">Todos</option>
        <option value="low">Baixo Estoque</option>
        {CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}
        </select>
        {user.role === ROLES.ADMIN && <Button onClick={() => openModal('inventory')} variant="primary"><Plus className="w-4 h-4 inline mr-2" /> Novo</Button>}
        </div>
        </div>
        <div className="overflow-x-auto">
        <table className="w-full text-sm text-left">
        <thead className="bg-zinc-950 border-b border-zinc-800">
        <tr><th className="px-6 py-3">Item</th><th className="px-6 py-3">Tipo</th><th className="px-6 py-3">Qtd</th><th className="px-6 py-3">Status</th>{showCosts && <th className="px-6 py-3">Custo</th>}<th className="px-6 py-3">Pre√ßo Venda</th><th className="px-6 py-3 text-center">A√ß√µes</th></tr>
        </thead>
        <tbody className="divide-y divide-zinc-800">
        {filteredInventory.map(item => (
          <tr key={item.id} className="hover:bg-zinc-800/50">
          <td className="px-6 py-4 text-zinc-200">{item.name}</td>
          <td className="px-6 py-4">
          {item.measureType === 'area' ?
            <span className="inline-flex items-center gap-1 text-[10px] uppercase font-bold text-blue-400 border border-blue-900 px-1 py-0.5 rounded"><Ruler size={10}/> √Årea (m¬≤)</span> :
            <span className="inline-flex items-center gap-1 text-[10px] uppercase font-bold text-orange-400 border border-orange-900 px-1 py-0.5 rounded"><Box size={10}/> Unidade</span>
          }
          </td>
          <td className="px-6 py-4">
          {item.category === 'Terceirizado' ? (
            <span className="text-zinc-500 font-bold text-xs uppercase bg-zinc-800 px-2 py-1 rounded">Externo</span>
          ) : (
            <span className="font-mono font-bold">{item.quantity} {item.unit}</span>
          )}
          </td>
          <td className="px-6 py-4">
          {item.category === 'Terceirizado' ? (
            <span className="text-blue-400 flex items-center gap-1 text-xs"><CheckSquare size={12}/> Servi√ßo</span>
          ) : (
            item.quantity <= item.minStock ?
            <span className="text-red-500 flex items-center gap-1"><AlertTriangle size={12}/> Baixo</span> : <span className="text-emerald-500 flex items-center gap-1"><CheckSquare size={12}/> OK</span>
          )}
          </td>
          {showCosts && <td className="px-6 py-4 font-mono">{formatCurrency(item.price)}</td>}
          <td className="px-6 py-4 font-mono text-emerald-400">{item.sellPrice > 0 ? formatCurrency(item.sellPrice) : '-'}</td>
          <td className="px-6 py-4 flex gap-2 justify-center">
          <Button onClick={() => openModal('movement', item)} variant="primary" className="px-2 py-1"><ArrowRightLeft size={14}/></Button>
          {showCosts && (<><Button onClick={() => openModal('inventory', item)} variant="secondary" className="px-2 py-1"><Edit size={14}/></Button><Button onClick={() => deleteData('inventory', item.id)} variant="danger" className="px-2 py-1"><Trash2 size={14}/></Button></>)}
          </td>
          </tr>
        ))}
        </tbody>
        </table>
        </div>
        </div>
        </div>
      );
    };

    const PrecificacaoView = () => (
      <div className="bg-zinc-900 border border-zinc-800 animate-in fade-in duration-300">
      <div className="p-6 border-b border-zinc-800 flex justify-between items-center">
      <div><h2 className="text-xl font-bold text-white uppercase tracking-wider">Cat√°logo de Servi√ßos (Produ√ß√£o)</h2></div>
      <Button onClick={() => openModal('service')} variant="primary"><Plus className="w-4 h-4 inline mr-2" /> Novo Servi√ßo</Button>
      </div>
      <div className="overflow-x-auto">
      <table className="w-full text-sm text-left">
      <thead className="bg-zinc-950 border-b border-zinc-800">
      <tr><th className="px-6 py-3">Servi√ßo</th><th className="px-6 py-3">Pre√ßo Base</th><th className="px-6 py-3">Tipo</th><th className="px-6 py-3">Estoque</th><th className="px-6 py-3">Extras</th><th className="px-6 py-3">A√ß√µes</th></tr>
      </thead>
      <tbody className="divide-y divide-zinc-800">
      {services.map(service => {
        const linkedStock = inventory.find(i => i.id === service.stockId);
        return (
          <tr key={service.id} className="hover:bg-zinc-800/50">
          <td className="px-6 py-4 text-zinc-200 font-bold">{service.name}</td>
          <td className="px-6 py-4 text-emerald-400 font-mono font-bold">{formatCurrency(service.basePrice)}</td>
          <td className="px-6 py-4 text-zinc-500 text-xs uppercase">{service.pricingType === 'area' ? 'Por m¬≤' : 'Por Folha'}</td>
          <td className="px-6 py-4">{linkedStock ? <span className="text-zinc-300 text-xs flex items-center gap-1"><Package size={12} className="text-blue-500"/> {linkedStock.name}</span> : <span className="text-red-500 text-xs italic">N√£o vinculado</span>}</td>
          <td className="px-6 py-4"><div className="flex flex-wrap gap-1">{service.extras?.map(ex => <span key={ex.id} className="px-2 py-1 bg-zinc-800 text-xs border border-zinc-700">{ex.name}</span>)}</div></td>
          <td className="px-6 py-4 flex gap-2">
          <Button onClick={() => openModal('service', service)} variant="secondary" className="px-2 py-1"><Edit size={14}/></Button>
          <Button onClick={() => deleteData('service', service.id)} variant="danger" className="px-2 py-1"><Trash2 size={14}/></Button>
          </td>
          </tr>
        );
      })}
      </tbody>
      </table>
      </div>
      </div>
    );

    const RelatoriosView = () => {
      return (
        <div className="bg-zinc-900 border border-zinc-800 animate-in fade-in duration-300">
        <div className="p-6 border-b border-zinc-800 bg-zinc-950">
        <div className="flex items-center gap-2 mb-4">
        <FileBarChart className="w-6 h-6 text-blue-500" />
        <h2 className="text-xl font-bold text-white uppercase tracking-wider">Central de Relat√≥rios</h2>
        </div>

        <div className="flex flex-wrap gap-4 items-end">
        <div className="flex flex-col gap-1 w-48">
        <label className="text-xs text-zinc-500 font-bold uppercase">Tipo de Relat√≥rio</label>
        <select
        value={reportType}
        onChange={(e) => setReportType(e.target.value)}
        className="bg-zinc-900 border border-zinc-700 text-white p-2 rounded-none text-sm focus:border-blue-500 outline-none"
        >
        <option value="vendas">Vendas e Or√ßamentos</option>
        <option value="financeiro">Financeiro (Caixa)</option>
        <option value="estoque">Invent√°rio de Estoque</option>
        </select>
        </div>

        {reportType !== 'estoque' && (
          <>
          <div className="flex flex-col gap-1 w-40">
          <label className="text-xs text-zinc-500 font-bold uppercase">Data Inicial</label>
          <input type="date" value={reportStartDate} onChange={(e) => setReportStartDate(e.target.value)} className="bg-zinc-900 border border-zinc-700 text-white p-2 rounded-none text-sm focus:border-blue-500 outline-none"/>
          </div>
          <div className="flex flex-col gap-1 w-40">
          <label className="text-xs text-zinc-500 font-bold uppercase">Data Final</label>
          <input type="date" value={reportEndDate} onChange={(e) => setReportEndDate(e.target.value)} className="bg-zinc-900 border border-zinc-700 text-white p-2 rounded-none text-sm focus:border-blue-500 outline-none"/>
          </div>
          </>
        )}

        <Button onClick={() => handlePrintReport(reportType, reportStartDate, reportEndDate)} variant="primary">
        <Printer size={16} className="mr-2"/> Gerar Relat√≥rio
        </Button>
        </div>
        </div>

        <div className="p-8 flex flex-col items-center justify-center h-64 text-zinc-600 border-t border-zinc-800 border-dashed">
        <FileText size={48} className="mb-4 opacity-50"/>
        <p>Selecione os filtros acima e clique em "Gerar Relat√≥rio" para imprimir ou salvar em PDF.</p>
        </div>
        </div>
      );
    };

    const ConfiguracoesView = () => (
      <div className="bg-zinc-900 border border-zinc-800 p-8 animate-in fade-in duration-300 max-w-5xl">
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div className="space-y-8">
      <h2 className="text-xl font-bold text-white uppercase tracking-wider mb-6 flex items-center gap-2 border-b border-zinc-800 pb-4"><Settings className="w-5 h-5" /> Configura√ß√µes</h2>

      <div className="pb-4">
      <h3 className="text-sm font-bold text-zinc-300 uppercase mb-4">Dados da Empresa (Fixos)</h3>
      <div className="space-y-3 text-sm text-zinc-400">
      <p><strong className="text-zinc-300">Nome Fantasia:</strong> {settings.name}</p>
      <p><strong className="text-zinc-300">Raz√£o Social:</strong> {settings.companyName}</p>
      <p><strong className="text-zinc-300">CNPJ:</strong> {settings.cnpj}</p>
      <p><strong className="text-zinc-300">Telefone:</strong> {settings.phone}</p>
      <p><strong className="text-zinc-300">Chave PIX:</strong> {settings.pixKey}</p>
      <p><strong className="text-zinc-300">Endere√ßo:</strong> {settings.address}</p>
      </div>
      </div>
      </div>
      <div className="bg-zinc-900 border border-zinc-800 p-6 h-fit">
      <h3 className="text-sm font-bold text-zinc-300 uppercase mb-4 flex items-center gap-2"><Activity className="w-4 h-4 text-emerald-500" /> Log de Atividades</h3>
      <div className="space-y-4 max-h-[500px] overflow-y-auto pr-2">
      {logs.map(log => (
        <div key={log.id} className="flex gap-3 text-sm border-b border-zinc-900 pb-2">
        <div className="text-zinc-500 font-mono text-xs whitespace-nowrap">{log.time}</div>
        <div><p className="text-zinc-200">{log.action}</p><p className="text-zinc-600 text-xs">por {log.user}</p></div>
        </div>
      ))}
      </div>
      </div>
      </div>
      </div>
    );

    const renderModalContent = () => {
      if (modalType === 'client') {
        return (
          <form onSubmit={saveData}>
          <Input label="Nome Completo" value={tempClient.name} onChange={e => setTempClient({...tempClient, name: e.target.value})} required />
          <Input label="CPF/CNPJ" value={tempClient.doc} onChange={e => setTempClient({...tempClient, doc: e.target.value})} />
          <Input label="Contato (WhatsApp)" value={tempClient.contact} onChange={e => setTempClient({...tempClient, contact: e.target.value})} placeholder="11999999999" />
          <Input label="Email" value={tempClient.email} onChange={e => setTempClient({...tempClient, email: e.target.value})} />
          <Button type="submit" variant="primary" className="w-full mt-4">Salvar Cadastro</Button>
          </form>
        );
      }
      // ... dentro de renderModalContent ...

      if (modalType === 'confirmOrder') {
        return (
          <form onSubmit={confirmCreateOrder}>
          <div className="bg-zinc-950 p-4 border border-zinc-800 mb-4">
          <p className="text-xs uppercase text-zinc-500">Agendamento de Entrega</p>
          <p className="text-zinc-300 text-sm">Defina o prazo limite para a produ√ß√£o deste pedido.</p>
          </div>

          <Input
          label="Data e Hora de Entrega"
          type="datetime-local"
          value={tempDeliveryDate}
          onChange={e => setTempDeliveryDate(e.target.value)}
          required
          />

          <Button type="submit" variant="success" className="w-full mt-4">
          <CheckCircle className="w-4 h-4 mr-2"/> Confirmar e Gerar Pedido
          </Button>
          </form>
        );
      }
      if (modalType === 'service') {
        return (
          <form onSubmit={saveData}>
          <Input label="Nome do Servi√ßo" value={tempService.name} onChange={e => setTempService({...tempService, name: e.target.value})} required />
          <div className="flex flex-col gap-1 mb-4 w-full">
          <label className="text-xs uppercase text-zinc-500 font-bold tracking-wider">Tipo de Precifica√ß√£o</label>
          <select className="bg-zinc-950 border border-zinc-700 text-zinc-200 p-2 rounded-none focus:border-blue-700 focus:outline-none font-mono text-sm w-full" value={tempService.pricingType} onChange={e => setTempService({...tempService, pricingType: e.target.value})}>
          <option value="sheet">Por Folha/Unidade (Aproveitamento)</option>
          <option value="area">Por Metro Quadrado (m¬≤)</option>
          </select>
          </div>
          {tempService.pricingType === 'sheet' && (
            <div className="grid grid-cols-2 gap-4">
            <Input label="Largura Base (cm)" type="number" value={tempService.w} onChange={e => setTempService({...tempService, w: e.target.value})} />
            <Input label="Altura Base (cm)" type="number" value={tempService.h} onChange={e => setTempService({...tempService, h: e.target.value})} />
            </div>
          )}
          <Input label={tempService.pricingType === 'area' ? "Pre√ßo por m¬≤ (R$)" : "Pre√ßo Base (por folha)"} type="number" value={tempService.basePrice} onChange={e => setTempService({...tempService, basePrice: e.target.value})} />
          <div className="flex flex-col gap-1 mb-4 w-full">
          <label className="text-xs uppercase text-zinc-500 font-bold tracking-wider">Material Estoque Vinculado</label>
          <select className="bg-zinc-950 border border-zinc-700 text-zinc-200 p-2 rounded-none focus:border-blue-700 focus:outline-none placeholder-zinc-700 font-mono text-sm w-full" value={tempService.stockId || ''} onChange={e => setTempService({...tempService, stockId: parseInt(e.target.value)})}>
          <option value="">Nenhum</option>
          {inventory.map(item => <option key={item.id} value={item.id}>{item.name}</option>)}
          </select>
          </div>
          <div className="border-t border-zinc-800 pt-4 mt-2">
          <label className="text-xs uppercase text-zinc-500 font-bold tracking-wider mb-2 block">Extras (Soma ao pre√ßo base)</label>
          <div className="flex gap-2 mb-4">
          <input placeholder="Ex: Recorte/Lamina√ß√£o" value={tempExtra.name} onChange={e => setTempExtra({...tempExtra, name: e.target.value})} className="bg-zinc-950 border border-zinc-700 text-zinc-200 p-2 text-xs flex-1" />
          <input placeholder="R$" type="number" value={tempExtra.value} onChange={e => setTempExtra({...tempExtra, value: e.target.value})} className="bg-zinc-950 border border-zinc-700 text-zinc-200 p-2 text-xs w-20" />
          <Button onClick={addExtraToService} variant="secondary" className="px-2"><Plus size={14}/></Button>
          </div>
          <ul className="space-y-1">
          {tempService.extras?.map(ex => (
            <li key={ex.id} className="flex justify-between items-center bg-zinc-950 p-2 text-xs border border-zinc-800">
            <span>{ex.name} (+ {formatCurrency(ex.value)})</span>
            <button type="button" onClick={() => removeExtraFromService(ex.id)} className="text-red-500"><X size={12}/></button>
            </li>
          ))}
          </ul>
          </div>
          <Button type="submit" variant="primary" className="w-full mt-4">Salvar Servi√ßo</Button>
          </form>
        );
      }
      if (modalType === 'inventory') {
        return (
          <form onSubmit={saveData}>
          <Input label="Nome do Material" value={tempInventory.name} onChange={e => setTempInventory({...tempInventory, name: e.target.value})} required />
          <div className="grid grid-cols-2 gap-4">
          <div className="flex flex-col gap-1 w-full">
          <label className="text-xs uppercase text-zinc-500 font-bold tracking-wider">Categoria</label>
          <select className="bg-zinc-950 border border-zinc-700 text-zinc-200 p-2 rounded-none focus:border-blue-700 focus:outline-none font-mono text-sm w-full" value={tempInventory.category} onChange={e => setTempInventory({...tempInventory, category: e.target.value})}>
          {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
          </select>
          </div>
          <div className="flex flex-col gap-1 w-full">
          <label className="text-xs uppercase text-zinc-500 font-bold tracking-wider">Tipo de Medida</label>
          <select className="bg-zinc-950 border border-zinc-700 text-zinc-200 p-2 rounded-none focus:border-blue-700 focus:outline-none font-mono text-sm w-full" value={tempInventory.measureType} onChange={e => setTempInventory({...tempInventory, measureType: e.target.value})}>
          <option value="unit">Por Unidade/Folha</option>
          <option value="area">Por √Årea (m¬≤)</option>
          </select>
          </div>
          </div>
          <div className="grid grid-cols-2 gap-4">
          <Input label="Unidade (Sigla)" value={tempInventory.unit} onChange={e => setTempInventory({...tempInventory, unit: e.target.value})} placeholder="fl, m¬≤, cx..." />
          <Input label="Custo Unit√°rio (R$)" type="number" value={tempInventory.price} onChange={e => setTempInventory({...tempInventory, price: e.target.value})} />
          </div>
          <div className="grid grid-cols-2 gap-4">
          <Input label="Pre√ßo de Venda (Revenda)" type="number" value={tempInventory.sellPrice || ''} onChange={e => setTempInventory({...tempInventory, sellPrice: e.target.value})} placeholder="Opcional" />
          <div className="flex flex-col gap-1 mb-4 w-full">
          <label className="text-xs uppercase text-zinc-500 font-bold tracking-wider">Margem de Lucro</label>
          <div className="bg-zinc-900 border border-zinc-700 p-2 text-sm text-zinc-400 font-mono">
          {tempInventory.sellPrice && tempInventory.price ?
            `${(((tempInventory.sellPrice - tempInventory.price) / tempInventory.price) * 100).toFixed(1)}%`
            : '-'}
            </div>
            </div>
            </div>
            {/* [MODIFICA√á√ÉO] Se for Terceirizado, esconde a contagem de estoque */}
            {tempInventory.category === 'Terceirizado' ? (
              <div className="bg-zinc-800 p-3 mb-4 rounded border border-zinc-700 text-center">
              <p className="text-zinc-400 text-xs">Item Terceirizado / Externo</p>
              <p className="text-white text-sm font-bold">Sem controle de estoque local</p>
              </div>
            ) : (
              <div className="grid grid-cols-2 gap-4">
              <Input label="Qtd Atual" type="number" value={tempInventory.quantity} onChange={e => setTempInventory({...tempInventory, quantity: e.target.value})} />
              <Input label="Estoque M√≠nimo" type="number" value={tempInventory.minStock} onChange={e => setTempInventory({...tempInventory, minStock: e.target.value})} />
              </div>
            )}
            <Button type="submit" variant="primary" className="w-full mt-4">Salvar Material</Button>
            </form>
        );
      }
      if (modalType === 'movement' && editingItem) {
        return (
          <div>
          <div className="bg-zinc-950 p-3 mb-4 border border-zinc-800">
          <p className="text-xs uppercase text-zinc-500">Ajuste F√≠sico: {editingItem.name}</p>
          <p className="text-white font-bold text-lg">{editingItem.quantity} {editingItem.unit}</p>
          </div>
          <div className="flex gap-2 mb-4">
          <Button onClick={() => setTempMovement({...tempMovement, type: 'in'})} className={`flex-1 ${tempMovement.type === 'in' ? 'bg-emerald-600 border-emerald-500' : 'bg-zinc-900 border-zinc-700'}`}>Entrada (+)</Button>
          <Button onClick={() => setTempMovement({...tempMovement, type: 'out'})} className={`flex-1 ${tempMovement.type === 'out' ? 'bg-red-600 border-red-500' : 'bg-zinc-900 border-zinc-700'}`}>Sa√≠da (-)</Button>
          </div>
          <Input label="Quantidade do Movimento" type="number" value={tempMovement.quantity} onChange={e => setTempMovement({...tempMovement, quantity: e.target.value})} />
          <Button onClick={saveData} variant="primary" className="w-full">Confirmar Registro</Button>
          </div>
        );
      }
      if (modalType === 'transaction') {
        return (
          <form onSubmit={saveData}>
          <div className="bg-zinc-950 p-3 mb-4 border border-zinc-800">
          <p className="text-xs uppercase text-zinc-500">Lan√ßamento Manual</p>
          <p className={`font-bold text-lg ${tempTransaction.type === 'in' ? 'text-emerald-500' : 'text-red-500'}`}>
          {tempTransaction.type === 'in' ? 'Nova Entrada (Receita)' : 'Nova Sa√≠da (Despesa)'}
          </p>
          </div>
          <Input label="Descri√ß√£o" value={tempTransaction.description} onChange={e => setTempTransaction({...tempTransaction, description: e.target.value})} placeholder={tempTransaction.type === 'in' ? 'Ex: Venda de Balc√£o' : 'Ex: Compra de Caf√©'} required />
          <Input label="Valor (R$)" type="number" value={tempTransaction.value} onChange={e => setTempTransaction({...tempTransaction, value: e.target.value})} required />
          <div className="flex flex-col gap-1 mb-4 w-full">
          <label className="text-xs uppercase text-zinc-500 font-bold tracking-wider">Categoria</label>
          <select className="bg-zinc-950 border border-zinc-700 text-zinc-200 p-2 rounded-none focus:border-blue-700 focus:outline-none font-mono text-sm w-full" value={tempTransaction.category} onChange={e => setTempTransaction({...tempTransaction, category: e.target.value})}>
          <option value="Vendas">Vendas</option>
          <option value="Servi√ßos">Servi√ßos</option>
          <option value="Despesas">Despesas</option>
          <option value="Outros">Outros</option>
          </select>
          </div>
          <div className="flex flex-col gap-1 mb-4 w-full">
          <label className="text-xs uppercase text-zinc-500 font-bold tracking-wider">M√©todo de Pagamento</label>
          <select className="bg-zinc-950 border border-zinc-700 text-zinc-200 p-2 rounded-none focus:border-blue-700 focus:outline-none font-mono text-sm w-full" value={tempTransaction.method} onChange={e => setTempTransaction({...tempTransaction, method: e.target.value})}>
          {PAYMENT_METHODS.map(method => <option key={method} value={method}>{method}</option>)}
          </select>
          </div>
          <Button type="submit" variant={tempTransaction.type === 'in' ? 'success' : 'danger'} className="w-full">Confirmar Lan√ßamento</Button>
          </form>
        );
      }
      if (modalType === 'openCash') {
        return (
          <form onSubmit={handleOpenCash}>
          <div className="bg-zinc-950 p-4 border border-zinc-800 mb-4">
          <p className="text-xs uppercase text-zinc-500">Abertura de Caixa</p>
          <p className="text-zinc-300 text-sm">Informe o valor f√≠sico dispon√≠vel na gaveta para iniciar as opera√ß√µes do dia.</p>
          </div>
          <Input label="Valor em Gaveta (R$)" type="number" value={openingValue} onChange={e => setOpeningValue(e.target.value)} required placeholder="0.00" />
          <Button type="submit" variant="success" className="w-full mt-2">Confirmar Abertura</Button>
          </form>
        );
      }
      if (modalType === 'payment') {
        return (
          <form onSubmit={confirmPayment}>
          <div className="bg-zinc-950 p-4 border border-zinc-800 mb-4">
          <p className="text-xs uppercase text-zinc-500">Valor Total do Pedido</p>
          <p className="text-xl font-mono text-white mb-2">{formatCurrency(paymentData.totalValue)}</p>
          <div className="h-px bg-zinc-800 w-full mb-2"></div>

          <div className="grid grid-cols-2 gap-4">
          <div>
          <p className="text-xs uppercase text-zinc-500">J√° Pago</p>
          <p className="text-sm font-mono text-blue-400">
          {formatCurrency(paymentData.totalValue - paymentData.minValue)}
          </p>
          </div>
          <div>
          <p className="text-xs uppercase text-zinc-500">M√≠nimo Agora</p>
          <p className="text-sm font-mono text-yellow-500">{formatCurrency(paymentData.minValue)}</p>
          </div>
          </div>
          </div>

          <Input label="Valor a Pagar (R$)" type="number" value={paymentData.payValue} onChange={e => setPaymentData({...paymentData, payValue: e.target.value})} required />

          <div className="flex flex-col gap-1 mb-4 w-full">
          <label className="text-xs uppercase text-zinc-500 font-bold tracking-wider">M√©todo de Pagamento</label>
          <select className="bg-zinc-950 border border-zinc-700 text-zinc-200 p-2 rounded-none focus:border-blue-700 focus:outline-none font-mono text-sm w-full" value={paymentData.method} onChange={e => setPaymentData({...paymentData, method: e.target.value})}>
          {PAYMENT_METHODS.map(method => <option key={method} value={method}>{method}</option>)}
          </select>
          </div>

          <Button type="submit" variant="success" className="w-full mt-2">Confirmar Recebimento</Button>
          </form>
        );
      }
      if (modalType === 'bill') {
        return (
          <form onSubmit={saveData}>
          <div className="bg-zinc-950 p-4 border border-zinc-800 mb-4">
          <p className="text-xs uppercase text-zinc-500">Agendar Pagamento</p>
          <p className="text-zinc-300 text-sm">Registre uma despesa futura para controle.</p>
          </div>

          <Input label="Descri√ß√£o" value={tempBill.description} onChange={e => setTempBill({...tempBill, description: e.target.value})} placeholder="Ex: Sal√°rio Jo√£o, Aluguel" required />

          <div className="grid grid-cols-2 gap-4">
          <Input label="Valor (R$)" type="number" value={tempBill.value} onChange={e => setTempBill({...tempBill, value: e.target.value})} required />
          <Input label="Data de Vencimento" type="date" value={tempBill.dueDate} onChange={e => setTempBill({...tempBill, dueDate: e.target.value})} required />
          </div>

          <div className="flex flex-col gap-1 mb-4 w-full">
          <label className="text-xs uppercase text-zinc-500 font-bold tracking-wider">Categoria</label>
          <select className="bg-zinc-950 border border-zinc-700 text-zinc-200 p-2 rounded-none focus:border-blue-700 focus:outline-none font-mono text-sm w-full" value={tempBill.category} onChange={e => setTempBill({...tempBill, category: e.target.value})}>
          {EXPENSE_CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}
          </select>
          </div>

          <div className="flex flex-col gap-1 mb-4 w-full">
          <label className="text-xs uppercase text-zinc-500 font-bold tracking-wider">Observa√ß√µes (Opcional)</label>
          <textarea
          className="bg-zinc-950 border border-zinc-700 text-zinc-200 p-2 rounded-none focus:border-blue-700 focus:outline-none placeholder-zinc-700 font-mono text-sm w-full h-20 resize-none"
          value={tempBill.obs}
          onChange={e => setTempBill({...tempBill, obs: e.target.value})}
          placeholder="Detalhes adicionais..."
          />
          </div>

          <Button type="submit" variant="primary" className="w-full">Salvar Conta</Button>
          </form>
        );
      }
      if (modalType === 'orderDetail' && editingItem) {
        return (
          <div className="space-y-4">
          <h4 className="font-bold text-white text-lg">{editingItem.client}</h4>
          <p className="text-zinc-400">{editingItem.description}</p>
          <div className="bg-zinc-950 p-4 border border-zinc-800">
          <div className="flex justify-between items-center mb-2">
          <span className="text-zinc-500 text-xs uppercase">Total da Venda</span>
          <span className="text-emerald-500 font-mono text-xl font-bold">{formatCurrency(editingItem.value)}</span>
          </div>
          <div className="flex justify-between items-center pt-2 border-t border-zinc-800">
          <span className="text-zinc-500 text-xs uppercase">Total Pago</span>
          <span className="text-blue-400 font-mono font-bold">{formatCurrency(editingItem.paidAmount || 0)}</span>
          </div>
          {editingItem.value > (editingItem.paidAmount || 0) && (
            <div className="flex justify-between items-center pt-2 mt-2 border-t border-dashed border-zinc-800">
            <span className="text-red-400 text-xs uppercase">Restante</span>
            <span className="text-red-400 font-mono font-bold">{formatCurrency(editingItem.value - (editingItem.paidAmount || 0))}</span>
            </div>
          )}
          </div>

          {editingItem.technicalData?.items && (
            <div className="bg-zinc-900 border border-zinc-800 p-3 max-h-[200px] overflow-y-auto">
            <p className="text-xs font-bold text-zinc-500 uppercase mb-2">Itens do Pedido</p>
            {editingItem.technicalData.items.map((it, idx) => (
              <div key={idx} className="flex justify-between items-center text-xs text-zinc-400 border-b border-zinc-800 pb-1 mb-1 last:border-0 last:pb-0 last:mb-0">
              <span>{it.quantity}x {it.serviceName}</span>
              <span>{formatCurrency(it.finalPrice)}</span>
              </div>
            ))}
            </div>
          )}

          <div className="flex gap-2">
          <Button onClick={() => handlePrintOP(editingItem)} variant="secondary" className="flex-1"><Printer size={16} className="mr-2"/> Proposta</Button>
          <Button onClick={() => sendWhatsApp(editingItem, 'orcamento')} variant="whatsapp" className="flex-1"><MessageCircle size={16} className="mr-2"/> WhatsApp</Button>
          </div>
          </div>
        );
      }
      if (modalType === 'productionManage' && editingItem) {
        const order = orders.find(o => o.id === editingItem.id) || editingItem;
        const steps = order.productionSteps || PRODUCTION_STEPS_TEMPLATE;
        const history = order.history || [];

        return (
          <div className="space-y-6">
          <div className="border-b border-zinc-800 pb-4">
          <h4 className="font-bold text-white text-lg">{order.client}</h4>
          <p className="text-zinc-400 text-sm">OP #{order.id} - {order.description}</p>
          </div>

          <div>
          <p className="text-xs font-bold text-zinc-500 uppercase mb-3 flex items-center gap-2"><CheckSquare size={14}/> Checklist de Etapas</p>
          <div className="space-y-2">
          {steps.map(step => (
            <div key={step.id} className={`flex items-center justify-between p-3 border ${step.done ? 'border-emerald-900 bg-emerald-900/10' : 'border-zinc-800 bg-zinc-900'}`}>
            <div className="flex items-center gap-3">
            <button
            onClick={() => toggleProductionStep(order.id, step.id)}
            className={`w-5 h-5 flex items-center justify-center border rounded transition-colors ${step.done ? 'bg-emerald-500 border-emerald-500 text-black' : 'border-zinc-600 hover:border-zinc-400'}`}
            >
            {step.done && <Check size={12} strokeWidth={4}/>}
            </button>
            <span className={`text-sm ${step.done ? 'text-zinc-300 line-through' : 'text-white'}`}>{step.label}</span>
            </div>
            </div>
          ))}
          </div>
          </div>

          <div>
          <p className="text-xs font-bold text-zinc-500 uppercase mb-3 flex items-center gap-2"><Edit size={14}/> Adicionar Observa√ß√£o</p>
          <div className="flex gap-2">
          <input
          type="text"
          value={productionNote}
          onChange={(e) => setProductionNote(e.target.value)}
          placeholder="Ex: Cliente pediu urg√™ncia..."
          className="flex-1 bg-zinc-950 border border-zinc-700 text-zinc-200 p-2 text-sm focus:border-blue-600 outline-none"
          />
          <Button onClick={() => addProductionNote(order.id)} variant="secondary" disabled={!productionNote.trim()}>Adicionar</Button>
          </div>
          </div>

          <div className="max-h-[200px] overflow-y-auto pr-2">
          <p className="text-xs font-bold text-zinc-500 uppercase mb-3 flex items-center gap-2"><Clock size={14}/> Linha do Tempo</p>
          <div className="relative border-l border-zinc-800 ml-2 space-y-4 pl-4">
          {history.slice().reverse().map((event, idx) => (
            <div key={idx} className="relative">
            <div className="absolute -left-[21px] top-1 w-2.5 h-2.5 rounded-full bg-zinc-700 border-2 border-zinc-950"></div>
            <p className="text-xs text-zinc-500 mb-0.5">{formatDateTime(event.date)} - <span className="text-zinc-400">{event.user}</span></p>
            <p className={`text-sm ${event.type === 'note' ? 'text-yellow-200 italic' : 'text-zinc-300'}`}>{event.action}</p>
            </div>
          ))}
          </div>
          </div>
          </div>
        );
      }
      return null;
    };

    if (!user) return <LoginScreen onLogin={(role) => {
      const newUser = { name: role === ROLES.ADMIN ? 'Admin Master' : role === ROLES.VENDEDOR ? 'Carlos Vendas' : 'Ana Design', role };
      setUser(newUser);
      localStorage.setItem('embyte_user', JSON.stringify(newUser)); // [NOVO] Salva no navegador
      setView(role === ROLES.DESIGNER ? 'producao' : 'financeiro');
      addLog(`Login ${role}`);
    }} />;

    return (
      <div className="flex h-screen bg-zinc-950 text-zinc-200 font-sans overflow-hidden selection:bg-blue-900 selection:text-white">
      {notification && <Toast message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}
      <Modal isOpen={modalOpen} onClose={() => setModalOpen(false)} title={modalType === 'client' ? 'Cadastro de Cliente' : modalType === 'service' ? 'Configurar Servi√ßo' : modalType === 'movement' ? 'Movimenta√ß√£o Manual' : modalType === 'transaction' ? 'Lan√ßamento no Caixa' : modalType === 'payment' ? 'Receber Pagamento' : modalType === 'inventory' ? 'Material de Estoque' : modalType === 'openCash' ? 'Abertura de Caixa' : modalType === 'productionManage' ? 'Gest√£o de Produ√ß√£o' : modalType === 'bill' ? 'Nova Conta a Pagar' : 'Detalhes do Pedido'}>
      {renderModalContent()}
      </Modal>
      <aside className="w-64 bg-zinc-900 border-r border-zinc-800 flex flex-col">
      <div className="p-6 border-b border-zinc-800">
      <h2 className="text-xl font-black tracking-tighter text-white uppercase">Embyte<span className="text-blue-600">.sys</span></h2>
      <div className="text-xs text-zinc-500 font-mono mt-1 uppercase flex items-center gap-1"><div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>{user.name}</div>
      </div>
      <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
      {(user.role === ROLES.ADMIN || user.role === ROLES.VENDEDOR) && (
        <>
        <button onClick={() => setView('clientes')} className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium uppercase tracking-wider transition-all border-l-2 ${view === 'clientes' ? 'bg-zinc-800 text-white border-blue-600' : 'text-zinc-400 border-transparent hover:bg-zinc-800'}`}><Users size={18} /> Clientes</button>
        <button onClick={() => setView('vendas')} className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium uppercase tracking-wider transition-all border-l-2 ${view === 'vendas' ? 'bg-zinc-800 text-white border-blue-600' : 'text-zinc-400 border-transparent hover:bg-zinc-800'}`}><ShoppingCart size={18} /> Or√ßamentos</button>
        <button onClick={() => setView('caixa')} className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium uppercase tracking-wider transition-all border-l-2 ${view === 'caixa' ? 'bg-zinc-800 text-white border-blue-600' : 'text-zinc-400 border-transparent hover:bg-zinc-800'}`}><Wallet size={18} /> Caixa Di√°rio</button>
        </>
      )}
      <button onClick={() => setView('producao')} className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium uppercase tracking-wider transition-all border-l-2 ${view === 'producao' ? 'bg-zinc-800 text-white border-blue-600' : 'text-zinc-400 border-transparent hover:bg-zinc-800'}`}><Printer size={18} /> Produ√ß√£o</button>
      {user.role === ROLES.ADMIN && (
        <>
        <button onClick={() => setView('financeiro')} className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium uppercase tracking-wider transition-all border-l-2 ${view === 'financeiro' ? 'bg-zinc-800 text-white border-blue-600' : 'text-zinc-400 border-transparent hover:bg-zinc-800'}`}><DollarSign size={18} /> Financeiro</button>
        <button onClick={() => setView('relatorios')} className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium uppercase tracking-wider transition-all border-l-2 ${view === 'relatorios' ? 'bg-zinc-800 text-white border-blue-600' : 'text-zinc-400 border-transparent hover:bg-zinc-800'}`}><FileBarChart size={18} /> Relat√≥rios</button>
        <button onClick={() => setView('precificacao')} className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium uppercase tracking-wider transition-all border-l-2 ${view === 'precificacao' ? 'bg-zinc-800 text-white border-blue-600' : 'text-zinc-400 border-transparent hover:bg-zinc-800'}`}><Tag size={18} /> Precifica√ß√£o</button>
        </>
      )}
      {user.role !== ROLES.DESIGNER && <button onClick={() => setView('estoque')} className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium uppercase tracking-wider transition-all border-l-2 ${view === 'estoque' ? 'bg-zinc-800 text-white border-blue-600' : 'text-zinc-400 border-transparent hover:bg-zinc-800'}`}><Package size={18} /> Estoque</button>}
      {user.role === ROLES.ADMIN && <button onClick={() => setView('configuracoes')} className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium uppercase tracking-wider transition-all border-l-2 ${view === 'configuracoes' ? 'bg-zinc-800 text-white border-blue-600' : 'text-zinc-400 border-transparent hover:bg-zinc-800'}`}><Settings size={18} /> Configura√ß√µes</button>}
      </nav>
      <div className="p-4 border-t border-zinc-800">
      <Button onClick={() => {
        localStorage.removeItem('embyte_user'); // [NOVO] Limpa o armazenamento
        setUser(null);
      }} variant="secondary" className="w-full flex items-center justify-center gap-2 text-xs"><LogOut size={14} /> Sair</Button>
      </div>
      </aside>
      <main className="flex-1 overflow-auto bg-zinc-950 p-8">
      <header className="flex justify-between items-center mb-8 pb-4 border-b border-zinc-800">
      <div>
      <h1 className="text-2xl font-bold text-white uppercase tracking-tight">
      {view === 'vendas' ? 'Vendas e Or√ßamentos' :
        view === 'clientes' ? 'Gest√£o de Clientes' :
        view === 'caixa' ? 'Fluxo de Caixa Di√°rio' :
        view === 'producao' ? 'Ch√£o de F√°brica (OPs)' :
        view === 'financeiro' ? 'Gest√£o Financeira' :
        view === 'relatorios' ? 'Central de Relat√≥rios' :
        view === 'estoque' ? 'Controle de Estoque' :
        view === 'precificacao' ? 'Cat√°logo de Servi√ßos' :
        view === 'configuracoes' ? 'Configura√ß√µes' : 'Painel'}
        </h1>
        <p className="text-zinc-500 text-sm font-mono mt-1 flex items-center gap-2">
        {new Date().toLocaleDateString('pt-PT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
        {isOffline && <span className="text-xs bg-red-900 text-red-200 px-2 py-0.5 rounded border border-red-700 flex items-center gap-1 font-bold animate-pulse"><WifiOff size={10}/> MODO OFFLINE (LEITURA)</span>}
        </p>
        </div>
        </header>
        {view === 'clientes' && (user.role === ROLES.ADMIN || user.role === ROLES.VENDEDOR) && ClientesView()}
        {view === 'vendas' && (user.role === ROLES.ADMIN || user.role === ROLES.VENDEDOR) && VendasView()}
        {view === 'caixa' && (user.role === ROLES.ADMIN || user.role === ROLES.VENDEDOR) && CaixaView()}
        {view === 'producao' && ProducaoView()}
        {view === 'financeiro' && user.role === ROLES.ADMIN && FinanceiroView()}
        {view === 'relatorios' && user.role === ROLES.ADMIN && RelatoriosView()}
        {view === 'estoque' && user.role !== ROLES.DESIGNER && EstoqueView()}
        {view === 'precificacao' && user.role === ROLES.ADMIN && PrecificacaoView()}
        {view === 'configuracoes' && user.role === ROLES.ADMIN && ConfiguracoesView()}
        </main>
        </div>
    );
}
